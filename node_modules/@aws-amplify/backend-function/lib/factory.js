import { AmplifyUserError, CallerDirectoryExtractor, TagName, } from '@aws-amplify/platform-core';
import { Duration, Size, Stack, Tags } from 'aws-cdk-lib';
import * as scheduler from 'aws-cdk-lib/aws-scheduler';
import * as targets from 'aws-cdk-lib/aws-scheduler-targets';
import { Architecture, LayerVersion, Runtime, } from 'aws-cdk-lib/aws-lambda';
import { LogLevel as EsBuildLogLevel, NodejsFunction, OutputFormat, } from 'aws-cdk-lib/aws-lambda-nodejs';
import { readFileSync } from 'fs';
import { createRequire } from 'module';
import { EOL } from 'os';
import * as path from 'path';
import { FunctionEnvironmentTranslator } from './function_env_translator.js';
import { FunctionEnvironmentTypeGenerator } from './function_env_type_generator.js';
import { FunctionLayerArnParser } from './layer_parser.js';
import { convertLoggingOptionsToCDK } from './logging_options_parser.js';
import { convertFunctionSchedulesToScheduleExpressions } from './schedule_parser.js';
import { ProvidedFunctionFactory, } from './provided_function_factory.js';
import { AmplifyFunctionBase } from './function_construct_base.js';
import { FunctionResourceAccessAcceptor } from './resource_access_acceptor.js';
/**
 * Entry point for defining a function in the Amplify ecosystem
 */
// This is the "implementation overload", it's not visible in public api.
// We have to use function notation instead of arrow notation.
// Arrow notation does not support overloads.
// eslint-disable-next-line no-restricted-syntax
export function defineFunction(propsOrProvider = {}, providerProps) {
    if (propsOrProvider && typeof propsOrProvider === 'function') {
        return new ProvidedFunctionFactory(propsOrProvider, providerProps);
    }
    return new FunctionFactory(propsOrProvider, new Error().stack);
}
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
class FunctionFactory {
    props;
    callerStack;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props, callerStack) {
        this.props = props;
        this.callerStack = callerStack;
    }
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, outputStorageStrategy, resourceNameValidator, }) => {
        if (!this.generator) {
            this.generator = new FunctionGenerator(this.hydrateDefaults(resourceNameValidator), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
    hydrateDefaults = (resourceNameValidator) => {
        const name = this.resolveName();
        resourceNameValidator?.validate(name);
        return {
            name,
            entry: this.resolveEntry(),
            timeoutSeconds: this.resolveTimeout(),
            memoryMB: this.resolveMemory(),
            ephemeralStorageSizeMB: this.resolveEphemeralStorageSize(),
            environment: this.resolveEnvironment(),
            runtime: this.resolveRuntime(),
            architecture: this.resolveArchitecture(),
            schedule: this.resolveSchedule(),
            bundling: this.resolveBundling(),
            layers: this.props.layers ?? {},
            resourceGroupName: this.props.resourceGroupName ?? 'function',
            logging: this.props.logging ?? {},
        };
    };
    resolveName = () => {
        // If name is set explicitly, use that
        if (this.props.name) {
            return this.props.name;
        }
        // If entry is set, use the basename of the entry path
        if (this.props.entry) {
            return path.parse(this.props.entry).name;
        }
        // Otherwise, use the directory name where the function is defined
        return path.basename(new CallerDirectoryExtractor(this.callerStack).extract());
    };
    resolveEntry = () => {
        // if entry is not set, default to handler.ts
        if (!this.props.entry) {
            return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), 'handler.ts');
        }
        // if entry is absolute use that
        if (path.isAbsolute(this.props.entry)) {
            return this.props.entry;
        }
        // if entry is relative, compute with respect to the caller directory
        return path.join(new CallerDirectoryExtractor(this.callerStack).extract(), this.props.entry);
    };
    resolveTimeout = () => {
        const timeoutMin = 1;
        const timeoutMax = 60 * 15; // 15 minutes in seconds
        const timeoutDefault = 3;
        if (this.props.timeoutSeconds === undefined) {
            return timeoutDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.timeoutSeconds, timeoutMin, timeoutMax)) {
            throw new AmplifyUserError('InvalidTimeoutError', {
                message: `Invalid function timeout of ${this.props.timeoutSeconds}`,
                resolution: `timeoutSeconds must be a whole number between ${timeoutMin} and ${timeoutMax} inclusive`,
            });
        }
        return this.props.timeoutSeconds;
    };
    resolveMemory = () => {
        const memoryMin = 128;
        const memoryMax = 10240;
        const memoryDefault = 512;
        if (this.props.memoryMB === undefined) {
            return memoryDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.memoryMB, memoryMin, memoryMax)) {
            throw new AmplifyUserError('InvalidMemoryMBError', {
                message: `Invalid function memoryMB of ${this.props.memoryMB}`,
                resolution: `memoryMB must be a whole number between ${memoryMin} and ${memoryMax} inclusive`,
            });
        }
        return this.props.memoryMB;
    };
    resolveEphemeralStorageSize = () => {
        const ephemeralStorageSizeMin = 512;
        const ephemeralStorageSizeMax = 10240;
        const ephemeralStorageSizeDefault = 512;
        if (this.props.ephemeralStorageSizeMB === undefined) {
            return ephemeralStorageSizeDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.ephemeralStorageSizeMB, ephemeralStorageSizeMin, ephemeralStorageSizeMax)) {
            throw new AmplifyUserError('InvalidEphemeralStorageSizeMBError', {
                message: `Invalid function ephemeralStorageSizeMB of ${this.props.ephemeralStorageSizeMB}`,
                resolution: `ephemeralStorageSizeMB must be a whole number between ${ephemeralStorageSizeMin} and ${ephemeralStorageSizeMax} inclusive`,
            });
        }
        return this.props.ephemeralStorageSizeMB;
    };
    resolveEnvironment = () => {
        if (this.props.environment === undefined) {
            return {};
        }
        const invalidKeys = [];
        Object.keys(this.props.environment).forEach((key) => {
            // validate using key pattern from https://docs.aws.amazon.com/lambda/latest/api/API_Environment.html
            if (!key.match(/^[a-zA-Z]([a-zA-Z0-9_])+$/)) {
                invalidKeys.push(key);
            }
        });
        if (invalidKeys.length > 0) {
            throw new AmplifyUserError('InvalidEnvironmentKeyError', {
                message: `Invalid function environment key(s): ${invalidKeys.join(', ')}`,
                resolution: 'Environment keys must match [a-zA-Z]([a-zA-Z0-9_])+ and be at least 2 characters',
            });
        }
        return this.props.environment;
    };
    resolveRuntime = () => {
        const runtimeDefault = 20;
        // if runtime is not set, default to the oldest LTS
        if (!this.props.runtime) {
            return runtimeDefault;
        }
        if (!(this.props.runtime in nodeVersionMap)) {
            throw new AmplifyUserError('InvalidRuntimeError', {
                message: `Invalid function runtime of ${this.props.runtime}`,
                resolution: `runtime must be one of the following: ${Object.keys(nodeVersionMap).join(', ')}`,
            });
        }
        return this.props.runtime;
    };
    resolveArchitecture = () => {
        const architectureDefault = 'x86_64';
        if (!this.props.architecture) {
            return architectureDefault;
        }
        if (!(this.props.architecture in architectureMap)) {
            throw new AmplifyUserError('InvalidArchitectureError', {
                message: `Invalid function architecture of ${this.props.architecture}`,
                resolution: `architecture must be one of the following: ${Object.keys(architectureMap).join(', ')}`,
            });
        }
        return this.props.architecture;
    };
    resolveSchedule = () => {
        if (!this.props.schedule) {
            return [];
        }
        return this.props.schedule;
    };
    resolveBundling = () => {
        const bundlingDefault = {
            format: OutputFormat.ESM,
            bundleAwsSDK: true,
            loader: {
                '.node': 'file',
            },
            minify: true,
            sourceMap: true,
        };
        return {
            ...bundlingDefault,
            minify: this.resolveMinify(this.props.bundling),
        };
    };
    resolveMinify = (bundling) => {
        return bundling?.minify === undefined ? true : bundling.minify;
    };
}
class FunctionGenerator {
    props;
    outputStorageStrategy;
    resourceGroupName;
    constructor(props, outputStorageStrategy) {
        this.props = props;
        this.outputStorageStrategy = outputStorageStrategy;
        this.resourceGroupName = props.resourceGroupName;
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        // Move layer resolution here where we have access to scope
        const parser = new FunctionLayerArnParser(Stack.of(scope).region, Stack.of(scope).account);
        const resolvedLayerArns = parser.parseLayers(this.props.layers ?? {}, this.props.name);
        // resolve layers to LayerVersion objects for the NodejsFunction constructor
        const resolvedLayers = Object.entries(resolvedLayerArns).map(([key, arn]) => LayerVersion.fromLayerVersionArn(scope, `${this.props.name}-${key}-layer`, arn));
        return new AmplifyFunction(scope, this.props.name, { ...this.props, resolvedLayers }, backendSecretResolver, this.outputStorageStrategy);
    };
}
class AmplifyFunction extends AmplifyFunctionBase {
    resources;
    functionEnvironmentTranslator;
    constructor(scope, id, props, backendSecretResolver, outputStorageStrategy) {
        super(scope, id, outputStorageStrategy);
        const runtime = nodeVersionMap[props.runtime];
        const require = createRequire(import.meta.url);
        const shims = runtime === Runtime.NODEJS_16_X
            ? []
            : [require.resolve('./lambda-shims/cjs_shim')];
        const ssmResolverFile = runtime === Runtime.NODEJS_16_X
            ? require.resolve('./lambda-shims/resolve_ssm_params_sdk_v2') // use aws cdk v2 in node 16
            : require.resolve('./lambda-shims/resolve_ssm_params');
        const invokeSsmResolverFile = require.resolve('./lambda-shims/invoke_ssm_shim');
        /**
         * This code concatenates the contents of the ssm resolver and invoker into a single line that can be used as the esbuild banner content
         * This banner is responsible for resolving the customer's SSM parameters at runtime
         */
        const bannerCode = readFileSync(ssmResolverFile, 'utf-8')
            .concat(readFileSync(invokeSsmResolverFile, 'utf-8'))
            .split(new RegExp(`${EOL}|\n|\r`, 'g'))
            .map((line) => line.replace(/\/\/.*$/, '')) // strip out inline comments because the banner is going to be flattened into a single line
            .join('');
        const functionEnvironmentTypeGenerator = new FunctionEnvironmentTypeGenerator(id);
        // esbuild runs as part of the NodejsFunction constructor, so we eagerly generate the process env shim without types so it can be included in the function bundle.
        // This will be overwritten with the typed file at the end of synthesis
        functionEnvironmentTypeGenerator.generateProcessEnvShim();
        let functionLambda;
        const cdkLoggingOptions = convertLoggingOptionsToCDK(props.logging);
        try {
            functionLambda = new NodejsFunction(scope, `${id}-lambda`, {
                entry: props.entry,
                timeout: Duration.seconds(props.timeoutSeconds),
                memorySize: props.memoryMB,
                architecture: architectureMap[props.architecture],
                ephemeralStorageSize: Size.mebibytes(props.ephemeralStorageSizeMB),
                runtime: nodeVersionMap[props.runtime],
                layers: props.resolvedLayers,
                bundling: {
                    ...props.bundling,
                    banner: bannerCode,
                    inject: shims,
                    externalModules: Object.keys(props.layers),
                    logLevel: EsBuildLogLevel.ERROR,
                },
                logRetention: cdkLoggingOptions.retention,
                applicationLogLevelV2: cdkLoggingOptions.level,
                loggingFormat: cdkLoggingOptions.format,
            });
        }
        catch (error) {
            // If the error is from ES Bundler which is executed as a child process by CDK,
            // then the error from CDK contains the command that was executed along with the exit status.
            // Wrapping it here  would cause the cdk_deployer to re-throw this wrapped exception
            // instead of scraping the stderr for actual ESBuild error.
            if (error instanceof Error &&
                error.message.match(/Failed to bundle asset.*exited with status/)) {
                throw error;
            }
            throw new AmplifyUserError('NodeJSFunctionConstructInitializationError', {
                message: 'Failed to instantiate nodejs function construct',
                resolution: 'See the underlying error message for more details. Use `--debug` for additional debugging information.',
            }, error);
        }
        try {
            const expressions = convertFunctionSchedulesToScheduleExpressions(functionLambda, props.schedule);
            const lambdaTarget = new targets.LambdaInvoke(functionLambda);
            expressions.forEach((expression, index) => {
                // Lambda name will be prepended to schedule id, so only using index here for uniqueness
                new scheduler.Schedule(functionLambda, `schedule${index}`, {
                    schedule: expression,
                    target: lambdaTarget,
                });
            });
        }
        catch (error) {
            throw new AmplifyUserError('FunctionScheduleInitializationError', {
                message: 'Failed to instantiate schedule for nodejs function',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(functionLambda).add(TagName.FRIENDLY_NAME, id);
        this.functionEnvironmentTranslator = new FunctionEnvironmentTranslator(functionLambda, props.environment, backendSecretResolver, functionEnvironmentTypeGenerator);
        this.resources = {
            lambda: functionLambda,
            cfnResources: {
                cfnFunction: functionLambda.node.findChild('Resource'),
            },
        };
        this.storeOutput();
    }
    addEnvironment = (key, value) => {
        this.functionEnvironmentTranslator.addEnvironmentEntry(key, value);
    };
    getResourceAccessAcceptor = () => new FunctionResourceAccessAcceptor(this, this.functionEnvironmentTranslator);
}
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const nodeVersionMap = {
    16: Runtime.NODEJS_16_X,
    18: Runtime.NODEJS_18_X,
    20: Runtime.NODEJS_20_X,
    22: Runtime.NODEJS_22_X,
};
const architectureMap = {
    arm64: Architecture.ARM_64,
    x86_64: Architecture.X86_64,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLE9BQU8sR0FDUixNQUFNLDRCQUE0QixDQUFDO0FBbUJwQyxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzFELE9BQU8sS0FBSyxTQUFTLE1BQU0sMkJBQTJCLENBQUM7QUFDdkQsT0FBTyxLQUFLLE9BQU8sTUFBTSxtQ0FBbUMsQ0FBQztBQUM3RCxPQUFPLEVBQ0wsWUFBWSxFQUlaLFlBQVksRUFDWixPQUFPLEdBQ1IsTUFBTSx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLEVBQ0wsUUFBUSxJQUFJLGVBQWUsRUFDM0IsY0FBYyxFQUNkLFlBQVksR0FDYixNQUFNLCtCQUErQixDQUFDO0FBRXZDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDbEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUN2QyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQzdFLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzNELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3pFLE9BQU8sRUFBRSw2Q0FBNkMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3JGLE9BQU8sRUFDTCx1QkFBdUIsR0FFeEIsTUFBTSxnQ0FBZ0MsQ0FBQztBQUN4QyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQXlEL0U7O0dBRUc7QUFDSCx5RUFBeUU7QUFDekUsOERBQThEO0FBQzlELDZDQUE2QztBQUM3QyxnREFBZ0Q7QUFDaEQsTUFBTSxVQUFVLGNBQWMsQ0FDNUIsa0JBQXFFLEVBQUUsRUFDdkUsYUFBcUM7SUFFckMsSUFBSSxlQUFlLElBQUksT0FBTyxlQUFlLEtBQUssVUFBVSxFQUFFLENBQUM7UUFDN0QsT0FBTyxJQUFJLHVCQUF1QixDQUFDLGVBQWUsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUNyRSxDQUFDO0lBQ0QsT0FBTyxJQUFJLGVBQWUsQ0FBQyxlQUFlLEVBQUUsSUFBSSxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNqRSxDQUFDO0FBZ0lEOztHQUVHO0FBQ0gsTUFBTSxlQUFlO0lBTUE7SUFDQTtJQU5YLFNBQVMsQ0FBbUM7SUFDcEQ7O09BRUc7SUFDSCxZQUNtQixLQUFvQixFQUNwQixXQUFvQjtRQURwQixVQUFLLEdBQUwsS0FBSyxDQUFlO1FBQ3BCLGdCQUFXLEdBQVgsV0FBVyxDQUFTO0lBQ3BDLENBQUM7SUFFSjs7T0FFRztJQUNILFdBQVcsR0FBRyxDQUFDLEVBQ2Isa0JBQWtCLEVBQ2xCLHFCQUFxQixFQUNyQixxQkFBcUIsR0FDWSxFQUFtQixFQUFFO1FBQ3RELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLGlCQUFpQixDQUNwQyxJQUFJLENBQUMsZUFBZSxDQUFDLHFCQUFxQixDQUFDLEVBQzNDLHFCQUFxQixDQUN0QixDQUFDO1FBQ0osQ0FBQztRQUNELE9BQU8sa0JBQWtCLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQW9CLENBQUM7SUFDNUUsQ0FBQyxDQUFDO0lBRU0sZUFBZSxHQUFHLENBQ3hCLHFCQUE2QyxFQUN0QixFQUFFO1FBQ3pCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNoQyxxQkFBcUIsRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFdEMsT0FBTztZQUNMLElBQUk7WUFDSixLQUFLLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUMxQixjQUFjLEVBQUUsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNyQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUM5QixzQkFBc0IsRUFBRSxJQUFJLENBQUMsMkJBQTJCLEVBQUU7WUFDMUQsV0FBVyxFQUFFLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtZQUN0QyxPQUFPLEVBQUUsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUM5QixZQUFZLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixFQUFFO1lBQ3hDLFFBQVEsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ2hDLFFBQVEsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ2hDLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxFQUFFO1lBQy9CLGlCQUFpQixFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsaUJBQWlCLElBQUksVUFBVTtZQUM3RCxPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksRUFBRTtTQUNsQyxDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRU0sV0FBVyxHQUFHLEdBQUcsRUFBRTtRQUN6QixzQ0FBc0M7UUFDdEMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3BCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDekIsQ0FBQztRQUNELHNEQUFzRDtRQUN0RCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDckIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQzNDLENBQUM7UUFFRCxrRUFBa0U7UUFDbEUsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUNsQixJQUFJLHdCQUF3QixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FDekQsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVNLFlBQVksR0FBRyxHQUFHLEVBQUU7UUFDMUIsNkNBQTZDO1FBQzdDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3RCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FDZCxJQUFJLHdCQUF3QixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFDeEQsWUFBWSxDQUNiLENBQUM7UUFDSixDQUFDO1FBRUQsZ0NBQWdDO1FBQ2hDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDdEMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUMxQixDQUFDO1FBRUQscUVBQXFFO1FBQ3JFLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FDZCxJQUFJLHdCQUF3QixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFDeEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQ2pCLENBQUM7SUFDSixDQUFDLENBQUM7SUFFTSxjQUFjLEdBQUcsR0FBRyxFQUFFO1FBQzVCLE1BQU0sVUFBVSxHQUFHLENBQUMsQ0FBQztRQUNyQixNQUFNLFVBQVUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsd0JBQXdCO1FBQ3BELE1BQU0sY0FBYyxHQUFHLENBQUMsQ0FBQztRQUN6QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQzVDLE9BQU8sY0FBYyxDQUFDO1FBQ3hCLENBQUM7UUFFRCxJQUNFLENBQUMsNkJBQTZCLENBQzVCLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxFQUN6QixVQUFVLEVBQ1YsVUFBVSxDQUNYLEVBQ0QsQ0FBQztZQUNELE1BQU0sSUFBSSxnQkFBZ0IsQ0FBQyxxQkFBcUIsRUFBRTtnQkFDaEQsT0FBTyxFQUFFLCtCQUErQixJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRTtnQkFDbkUsVUFBVSxFQUFFLGlEQUFpRCxVQUFVLFFBQVEsVUFBVSxZQUFZO2FBQ3RHLENBQUMsQ0FBQztRQUNMLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDO0lBQ25DLENBQUMsQ0FBQztJQUVNLGFBQWEsR0FBRyxHQUFHLEVBQUU7UUFDM0IsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDO1FBQ3RCLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQztRQUN4QixNQUFNLGFBQWEsR0FBRyxHQUFHLENBQUM7UUFDMUIsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUN0QyxPQUFPLGFBQWEsQ0FBQztRQUN2QixDQUFDO1FBQ0QsSUFDRSxDQUFDLDZCQUE2QixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsRUFDekUsQ0FBQztZQUNELE1BQU0sSUFBSSxnQkFBZ0IsQ0FBQyxzQkFBc0IsRUFBRTtnQkFDakQsT0FBTyxFQUFFLGdDQUFnQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDOUQsVUFBVSxFQUFFLDJDQUEyQyxTQUFTLFFBQVEsU0FBUyxZQUFZO2FBQzlGLENBQUMsQ0FBQztRQUNMLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO0lBQzdCLENBQUMsQ0FBQztJQUVNLDJCQUEyQixHQUFHLEdBQUcsRUFBRTtRQUN6QyxNQUFNLHVCQUF1QixHQUFHLEdBQUcsQ0FBQztRQUNwQyxNQUFNLHVCQUF1QixHQUFHLEtBQUssQ0FBQztRQUN0QyxNQUFNLDJCQUEyQixHQUFHLEdBQUcsQ0FBQztRQUN4QyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDcEQsT0FBTywyQkFBMkIsQ0FBQztRQUNyQyxDQUFDO1FBQ0QsSUFDRSxDQUFDLDZCQUE2QixDQUM1QixJQUFJLENBQUMsS0FBSyxDQUFDLHNCQUFzQixFQUNqQyx1QkFBdUIsRUFDdkIsdUJBQXVCLENBQ3hCLEVBQ0QsQ0FBQztZQUNELE1BQU0sSUFBSSxnQkFBZ0IsQ0FBQyxvQ0FBb0MsRUFBRTtnQkFDL0QsT0FBTyxFQUFFLDhDQUE4QyxJQUFJLENBQUMsS0FBSyxDQUFDLHNCQUFzQixFQUFFO2dCQUMxRixVQUFVLEVBQUUseURBQXlELHVCQUF1QixRQUFRLHVCQUF1QixZQUFZO2FBQ3hJLENBQUMsQ0FBQztRQUNMLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsc0JBQXNCLENBQUM7SUFDM0MsQ0FBQyxDQUFDO0lBRU0sa0JBQWtCLEdBQUcsR0FBRyxFQUFFO1FBQ2hDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDekMsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDO1FBRUQsTUFBTSxXQUFXLEdBQWEsRUFBRSxDQUFDO1FBRWpDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUNsRCxxR0FBcUc7WUFDckcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsMkJBQTJCLENBQUMsRUFBRSxDQUFDO2dCQUM1QyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3hCLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUMzQixNQUFNLElBQUksZ0JBQWdCLENBQUMsNEJBQTRCLEVBQUU7Z0JBQ3ZELE9BQU8sRUFBRSx3Q0FBd0MsV0FBVyxDQUFDLElBQUksQ0FDL0QsSUFBSSxDQUNMLEVBQUU7Z0JBQ0gsVUFBVSxFQUNSLGtGQUFrRjthQUNyRixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQztJQUNoQyxDQUFDLENBQUM7SUFFTSxjQUFjLEdBQUcsR0FBRyxFQUFFO1FBQzVCLE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUUxQixtREFBbUQ7UUFDbkQsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDeEIsT0FBTyxjQUFjLENBQUM7UUFDeEIsQ0FBQztRQUVELElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxJQUFJLGNBQWMsQ0FBQyxFQUFFLENBQUM7WUFDNUMsTUFBTSxJQUFJLGdCQUFnQixDQUFDLHFCQUFxQixFQUFFO2dCQUNoRCxPQUFPLEVBQUUsK0JBQStCLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFO2dCQUM1RCxVQUFVLEVBQUUseUNBQXlDLE1BQU0sQ0FBQyxJQUFJLENBQzlELGNBQWMsQ0FDZixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTthQUNmLENBQUMsQ0FBQztRQUNMLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO0lBQzVCLENBQUMsQ0FBQztJQUVNLG1CQUFtQixHQUFHLEdBQUcsRUFBRTtRQUNqQyxNQUFNLG1CQUFtQixHQUFHLFFBQVEsQ0FBQztRQUVyQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUM3QixPQUFPLG1CQUFtQixDQUFDO1FBQzdCLENBQUM7UUFFRCxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDO1lBQ2xELE1BQU0sSUFBSSxnQkFBZ0IsQ0FBQywwQkFBMEIsRUFBRTtnQkFDckQsT0FBTyxFQUFFLG9DQUFvQyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRTtnQkFDdEUsVUFBVSxFQUFFLDhDQUE4QyxNQUFNLENBQUMsSUFBSSxDQUNuRSxlQUFlLENBQ2hCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO2FBQ2YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7SUFDakMsQ0FBQyxDQUFDO0lBRU0sZUFBZSxHQUFHLEdBQUcsRUFBRTtRQUM3QixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUN6QixPQUFPLEVBQUUsQ0FBQztRQUNaLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO0lBQzdCLENBQUMsQ0FBQztJQUVNLGVBQWUsR0FBRyxHQUFHLEVBQUU7UUFDN0IsTUFBTSxlQUFlLEdBQUc7WUFDdEIsTUFBTSxFQUFFLFlBQVksQ0FBQyxHQUFHO1lBQ3hCLFlBQVksRUFBRSxJQUFJO1lBQ2xCLE1BQU0sRUFBRTtnQkFDTixPQUFPLEVBQUUsTUFBTTthQUNoQjtZQUNELE1BQU0sRUFBRSxJQUFJO1lBQ1osU0FBUyxFQUFFLElBQUk7U0FDaEIsQ0FBQztRQUVGLE9BQU87WUFDTCxHQUFHLGVBQWU7WUFDbEIsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUM7U0FDaEQsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVNLGFBQWEsR0FBRyxDQUFDLFFBQWtDLEVBQUUsRUFBRTtRQUM3RCxPQUFPLFFBQVEsRUFBRSxNQUFNLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7SUFDakUsQ0FBQyxDQUFDO0NBQ0g7QUFJRCxNQUFNLGlCQUFpQjtJQUlGO0lBQ0E7SUFKVixpQkFBaUIsQ0FBMkI7SUFFckQsWUFDbUIsS0FBNEIsRUFDNUIscUJBQW1FO1FBRG5FLFVBQUssR0FBTCxLQUFLLENBQXVCO1FBQzVCLDBCQUFxQixHQUFyQixxQkFBcUIsQ0FBOEM7UUFFcEYsSUFBSSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQztJQUNuRCxDQUFDO0lBRUQsc0JBQXNCLEdBQUcsQ0FBQyxFQUN4QixLQUFLLEVBQ0wscUJBQXFCLEdBQ08sRUFBRSxFQUFFO1FBQ2hDLDJEQUEyRDtRQUMzRCxNQUFNLE1BQU0sR0FBRyxJQUFJLHNCQUFzQixDQUN2QyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sRUFDdEIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLENBQ3hCLENBQUM7UUFDRixNQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQzFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxJQUFJLEVBQUUsRUFDdkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQ2hCLENBQUM7UUFFRiw0RUFBNEU7UUFDNUUsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FDMUUsWUFBWSxDQUFDLG1CQUFtQixDQUM5QixLQUFLLEVBQ0wsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxHQUFHLFFBQVEsRUFDakMsR0FBRyxDQUNKLENBQ0YsQ0FBQztRQUVGLE9BQU8sSUFBSSxlQUFlLENBQ3hCLEtBQUssRUFDTCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFDZixFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxjQUFjLEVBQUUsRUFDakMscUJBQXFCLEVBQ3JCLElBQUksQ0FBQyxxQkFBcUIsQ0FDM0IsQ0FBQztJQUNKLENBQUMsQ0FBQztDQUNIO0FBRUQsTUFBTSxlQUNKLFNBQVEsbUJBQW1CO0lBR2xCLFNBQVMsQ0FBb0I7SUFDckIsNkJBQTZCLENBQWdDO0lBQzlFLFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLEtBQWtFLEVBQ2xFLHFCQUE0QyxFQUM1QyxxQkFBbUU7UUFFbkUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUscUJBQXFCLENBQUMsQ0FBQztRQUV4QyxNQUFNLE9BQU8sR0FBRyxjQUFjLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRTlDLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRS9DLE1BQU0sS0FBSyxHQUNULE9BQU8sS0FBSyxPQUFPLENBQUMsV0FBVztZQUM3QixDQUFDLENBQUMsRUFBRTtZQUNKLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMseUJBQXlCLENBQUMsQ0FBQyxDQUFDO1FBRW5ELE1BQU0sZUFBZSxHQUNuQixPQUFPLEtBQUssT0FBTyxDQUFDLFdBQVc7WUFDN0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsMENBQTBDLENBQUMsQ0FBQyw0QkFBNEI7WUFDMUYsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsbUNBQW1DLENBQUMsQ0FBQztRQUUzRCxNQUFNLHFCQUFxQixHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQzNDLGdDQUFnQyxDQUNqQyxDQUFDO1FBRUY7OztXQUdHO1FBQ0gsTUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDLGVBQWUsRUFBRSxPQUFPLENBQUM7YUFDdEQsTUFBTSxDQUFDLFlBQVksQ0FBQyxxQkFBcUIsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUNwRCxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsR0FBRyxHQUFHLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQzthQUN0QyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsMkZBQTJGO2FBQ3RJLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVaLE1BQU0sZ0NBQWdDLEdBQ3BDLElBQUksZ0NBQWdDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFM0Msa0tBQWtLO1FBQ2xLLHVFQUF1RTtRQUN2RSxnQ0FBZ0MsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBRTFELElBQUksY0FBOEIsQ0FBQztRQUNuQyxNQUFNLGlCQUFpQixHQUFHLDBCQUEwQixDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUM7WUFDSCxjQUFjLEdBQUcsSUFBSSxjQUFjLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUU7Z0JBQ3pELEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSztnQkFDbEIsT0FBTyxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQztnQkFDL0MsVUFBVSxFQUFFLEtBQUssQ0FBQyxRQUFRO2dCQUMxQixZQUFZLEVBQUUsZUFBZSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7Z0JBQ2pELG9CQUFvQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDO2dCQUNsRSxPQUFPLEVBQUUsY0FBYyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUM7Z0JBQ3RDLE1BQU0sRUFBRSxLQUFLLENBQUMsY0FBYztnQkFDNUIsUUFBUSxFQUFFO29CQUNSLEdBQUcsS0FBSyxDQUFDLFFBQVE7b0JBQ2pCLE1BQU0sRUFBRSxVQUFVO29CQUNsQixNQUFNLEVBQUUsS0FBSztvQkFDYixlQUFlLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO29CQUMxQyxRQUFRLEVBQUUsZUFBZSxDQUFDLEtBQUs7aUJBQ2hDO2dCQUNELFlBQVksRUFBRSxpQkFBaUIsQ0FBQyxTQUFTO2dCQUN6QyxxQkFBcUIsRUFBRSxpQkFBaUIsQ0FBQyxLQUFLO2dCQUM5QyxhQUFhLEVBQUUsaUJBQWlCLENBQUMsTUFBTTthQUN4QyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLCtFQUErRTtZQUMvRSw2RkFBNkY7WUFDN0Ysb0ZBQW9GO1lBQ3BGLDJEQUEyRDtZQUMzRCxJQUNFLEtBQUssWUFBWSxLQUFLO2dCQUN0QixLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxFQUNqRSxDQUFDO2dCQUNELE1BQU0sS0FBSyxDQUFDO1lBQ2QsQ0FBQztZQUNELE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsNENBQTRDLEVBQzVDO2dCQUNFLE9BQU8sRUFBRSxpREFBaUQ7Z0JBQzFELFVBQVUsRUFDUix3R0FBd0c7YUFDM0csRUFDRCxLQUFjLENBQ2YsQ0FBQztRQUNKLENBQUM7UUFFRCxJQUFJLENBQUM7WUFDSCxNQUFNLFdBQVcsR0FBRyw2Q0FBNkMsQ0FDL0QsY0FBYyxFQUNkLEtBQUssQ0FBQyxRQUFRLENBQ2YsQ0FBQztZQUVGLE1BQU0sWUFBWSxHQUFHLElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUU5RCxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxFQUFFO2dCQUN4Qyx3RkFBd0Y7Z0JBQ3hGLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsV0FBVyxLQUFLLEVBQUUsRUFBRTtvQkFDekQsUUFBUSxFQUFFLFVBQVU7b0JBQ3BCLE1BQU0sRUFBRSxZQUFZO2lCQUNyQixDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsTUFBTSxJQUFJLGdCQUFnQixDQUN4QixxQ0FBcUMsRUFDckM7Z0JBQ0UsT0FBTyxFQUFFLG9EQUFvRDtnQkFDN0QsVUFBVSxFQUFFLG9EQUFvRDthQUNqRSxFQUNELEtBQWMsQ0FDZixDQUFDO1FBQ0osQ0FBQztRQUVELElBQUksQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLDZCQUE2QixHQUFHLElBQUksNkJBQTZCLENBQ3BFLGNBQWMsRUFDZCxLQUFLLENBQUMsV0FBVyxFQUNqQixxQkFBcUIsRUFDckIsZ0NBQWdDLENBQ2pDLENBQUM7UUFFRixJQUFJLENBQUMsU0FBUyxHQUFHO1lBQ2YsTUFBTSxFQUFFLGNBQWM7WUFDdEIsWUFBWSxFQUFFO2dCQUNaLFdBQVcsRUFBRSxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQWdCO2FBQ3RFO1NBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsY0FBYyxHQUFHLENBQUMsR0FBVyxFQUFFLEtBQTZCLEVBQUUsRUFBRTtRQUM5RCxJQUFJLENBQUMsNkJBQTZCLENBQUMsbUJBQW1CLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3JFLENBQUMsQ0FBQztJQUVGLHlCQUF5QixHQUFHLEdBQTJCLEVBQUUsQ0FDdkQsSUFBSSw4QkFBOEIsQ0FDaEMsSUFBSSxFQUNKLElBQUksQ0FBQyw2QkFBNkIsQ0FDbkMsQ0FBQztDQUNMO0FBRUQsTUFBTSw2QkFBNkIsR0FBRyxDQUNwQyxJQUFZLEVBQ1osR0FBVyxFQUNYLEdBQVcsRUFDWCxFQUFFLENBQUMsR0FBRyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksR0FBRyxJQUFJLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBSWxELE1BQU0sY0FBYyxHQUFpQztJQUNuRCxFQUFFLEVBQUUsT0FBTyxDQUFDLFdBQVc7SUFDdkIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0lBQ3ZCLEVBQUUsRUFBRSxPQUFPLENBQUMsV0FBVztJQUN2QixFQUFFLEVBQUUsT0FBTyxDQUFDLFdBQVc7Q0FDeEIsQ0FBQztBQUlGLE1BQU0sZUFBZSxHQUErQztJQUNsRSxLQUFLLEVBQUUsWUFBWSxDQUFDLE1BQU07SUFDMUIsTUFBTSxFQUFFLFlBQVksQ0FBQyxNQUFNO0NBQzVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGdW5jdGlvbk91dHB1dCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7XG4gIEFtcGxpZnlVc2VyRXJyb3IsXG4gIENhbGxlckRpcmVjdG9yeUV4dHJhY3RvcixcbiAgVGFnTmFtZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHtcbiAgQW1wbGlmeVJlc291cmNlR3JvdXBOYW1lLFxuICBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICBCYWNrZW5kU2VjcmV0LFxuICBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yLFxuICBDb25zdHJ1Y3RGYWN0b3J5LFxuICBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbiAgRnVuY3Rpb25SZXNvdXJjZXMsXG4gIEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcyxcbiAgTG9nTGV2ZWwsXG4gIExvZ1JldGVudGlvbixcbiAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvcixcbiAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnksXG4gIFJlc291cmNlTmFtZVZhbGlkYXRvcixcbiAgUmVzb3VyY2VQcm92aWRlcixcbiAgU3RhY2tQcm92aWRlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBEdXJhdGlvbiwgU2l6ZSwgU3RhY2ssIFRhZ3MgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBzY2hlZHVsZXIgZnJvbSAnYXdzLWNkay1saWIvYXdzLXNjaGVkdWxlcic7XG5pbXBvcnQgKiBhcyB0YXJnZXRzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zY2hlZHVsZXItdGFyZ2V0cyc7XG5pbXBvcnQge1xuICBBcmNoaXRlY3R1cmUsXG4gIENmbkZ1bmN0aW9uLFxuICBJRnVuY3Rpb24sXG4gIElMYXllclZlcnNpb24sXG4gIExheWVyVmVyc2lvbixcbiAgUnVudGltZSxcbn0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQge1xuICBMb2dMZXZlbCBhcyBFc0J1aWxkTG9nTGV2ZWwsXG4gIE5vZGVqc0Z1bmN0aW9uLFxuICBPdXRwdXRGb3JtYXQsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgY3JlYXRlUmVxdWlyZSB9IGZyb20gJ21vZHVsZSc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IgfSBmcm9tICcuL2Z1bmN0aW9uX2Vudl90cmFuc2xhdG9yLmpzJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHlwZV9nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgRnVuY3Rpb25MYXllckFyblBhcnNlciB9IGZyb20gJy4vbGF5ZXJfcGFyc2VyLmpzJztcbmltcG9ydCB7IGNvbnZlcnRMb2dnaW5nT3B0aW9uc1RvQ0RLIH0gZnJvbSAnLi9sb2dnaW5nX29wdGlvbnNfcGFyc2VyLmpzJztcbmltcG9ydCB7IGNvbnZlcnRGdW5jdGlvblNjaGVkdWxlc1RvU2NoZWR1bGVFeHByZXNzaW9ucyB9IGZyb20gJy4vc2NoZWR1bGVfcGFyc2VyLmpzJztcbmltcG9ydCB7XG4gIFByb3ZpZGVkRnVuY3Rpb25GYWN0b3J5LFxuICBQcm92aWRlZEZ1bmN0aW9uUHJvcHMsXG59IGZyb20gJy4vcHJvdmlkZWRfZnVuY3Rpb25fZmFjdG9yeS5qcyc7XG5pbXBvcnQgeyBBbXBsaWZ5RnVuY3Rpb25CYXNlIH0gZnJvbSAnLi9mdW5jdGlvbl9jb25zdHJ1Y3RfYmFzZS5qcyc7XG5pbXBvcnQgeyBGdW5jdGlvblJlc291cmNlQWNjZXNzQWNjZXB0b3IgfSBmcm9tICcuL3Jlc291cmNlX2FjY2Vzc19hY2NlcHRvci5qcyc7XG5cbmV4cG9ydCB0eXBlIEFkZEVudmlyb25tZW50RmFjdG9yeSA9IHtcbiAgYWRkRW52aXJvbm1lbnQ6IChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IEJhY2tlbmRTZWNyZXQpID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgdHlwZSBDcm9uU2NoZWR1bGVFeHByZXNzaW9uID1cbiAgfCBgJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfWBcbiAgfCBgJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ31gO1xuXG5leHBvcnQgdHlwZSBab25lZENyb25TY2hlZHVsZSA9IHtcbiAgY3JvbjogQ3JvblNjaGVkdWxlRXhwcmVzc2lvbjtcbiAgdGltZXpvbmU6IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIENyb25TY2hlZHVsZSA9IENyb25TY2hlZHVsZUV4cHJlc3Npb24gfCBab25lZENyb25TY2hlZHVsZTtcblxuZXhwb3J0IHR5cGUgVGltZUludGVydmFsRXhwcmVzc2lvbiA9XG4gIHwgYGV2ZXJ5ICR7bnVtYmVyfW1gXG4gIHwgYGV2ZXJ5ICR7bnVtYmVyfWhgXG4gIHwgYGV2ZXJ5IGRheWBcbiAgfCBgZXZlcnkgd2Vla2BcbiAgfCBgZXZlcnkgbW9udGhgXG4gIHwgYGV2ZXJ5IHllYXJgO1xuXG5leHBvcnQgdHlwZSBab25lZFRpbWVJbnRlcnZhbCA9IHtcbiAgcmF0ZTogVGltZUludGVydmFsRXhwcmVzc2lvbjtcbiAgdGltZXpvbmU6IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIFRpbWVJbnRlcnZhbCA9IFpvbmVkVGltZUludGVydmFsIHwgVGltZUludGVydmFsRXhwcmVzc2lvbjtcblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25TY2hlZHVsZSA9IFRpbWVJbnRlcnZhbCB8IENyb25TY2hlZHVsZTtcblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25Mb2dMZXZlbCA9IEV4dHJhY3Q8XG4gIExvZ0xldmVsLFxuICAnaW5mbycgfCAnZGVidWcnIHwgJ3dhcm4nIHwgJ2Vycm9yJyB8ICdmYXRhbCcgfCAndHJhY2UnXG4+O1xuZXhwb3J0IHR5cGUgRnVuY3Rpb25Mb2dSZXRlbnRpb24gPSBMb2dSZXRlbnRpb247XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWZpbmVGdW5jdGlvbihcbiAgcHJvcHM/OiBGdW5jdGlvblByb3BzLFxuKTogQ29uc3RydWN0RmFjdG9yeTxcbiAgUmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4gJlxuICAgIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5ICZcbiAgICBBZGRFbnZpcm9ubWVudEZhY3RvcnkgJlxuICAgIFN0YWNrUHJvdmlkZXJcbj47XG5leHBvcnQgZnVuY3Rpb24gZGVmaW5lRnVuY3Rpb24oXG4gIHByb3ZpZGVyOiAoc2NvcGU6IENvbnN0cnVjdCkgPT4gSUZ1bmN0aW9uLFxuICBwcm92aWRlclByb3BzPzogUHJvdmlkZWRGdW5jdGlvblByb3BzLFxuKTogQ29uc3RydWN0RmFjdG9yeTxcbiAgUmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4gJlxuICAgIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5ICZcbiAgICBBZGRFbnZpcm9ubWVudEZhY3RvcnkgJlxuICAgIFN0YWNrUHJvdmlkZXJcbj47XG4vKipcbiAqIEVudHJ5IHBvaW50IGZvciBkZWZpbmluZyBhIGZ1bmN0aW9uIGluIHRoZSBBbXBsaWZ5IGVjb3N5c3RlbVxuICovXG4vLyBUaGlzIGlzIHRoZSBcImltcGxlbWVudGF0aW9uIG92ZXJsb2FkXCIsIGl0J3Mgbm90IHZpc2libGUgaW4gcHVibGljIGFwaS5cbi8vIFdlIGhhdmUgdG8gdXNlIGZ1bmN0aW9uIG5vdGF0aW9uIGluc3RlYWQgb2YgYXJyb3cgbm90YXRpb24uXG4vLyBBcnJvdyBub3RhdGlvbiBkb2VzIG5vdCBzdXBwb3J0IG92ZXJsb2Fkcy5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1yZXN0cmljdGVkLXN5bnRheFxuZXhwb3J0IGZ1bmN0aW9uIGRlZmluZUZ1bmN0aW9uKFxuICBwcm9wc09yUHJvdmlkZXI6IEZ1bmN0aW9uUHJvcHMgfCAoKHNjb3BlOiBDb25zdHJ1Y3QpID0+IElGdW5jdGlvbikgPSB7fSxcbiAgcHJvdmlkZXJQcm9wcz86IFByb3ZpZGVkRnVuY3Rpb25Qcm9wcyxcbik6IHVua25vd24ge1xuICBpZiAocHJvcHNPclByb3ZpZGVyICYmIHR5cGVvZiBwcm9wc09yUHJvdmlkZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gbmV3IFByb3ZpZGVkRnVuY3Rpb25GYWN0b3J5KHByb3BzT3JQcm92aWRlciwgcHJvdmlkZXJQcm9wcyk7XG4gIH1cbiAgcmV0dXJuIG5ldyBGdW5jdGlvbkZhY3RvcnkocHJvcHNPclByb3ZpZGVyLCBuZXcgRXJyb3IoKS5zdGFjayk7XG59XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uUHJvcHMgPSB7XG4gIC8qKlxuICAgKiBBIG5hbWUgZm9yIHRoZSBmdW5jdGlvbi5cbiAgICogRGVmYXVsdHMgdG8gdGhlIGJhc2VuYW1lIG9mIHRoZSBlbnRyeSBwYXRoIGlmIHNwZWNpZmllZC5cbiAgICogSWYgbm8gZW50cnkgaXMgc3BlY2lmaWVkLCBkZWZhdWx0cyB0byB0aGUgZGlyZWN0b3J5IG5hbWUgaW4gd2hpY2ggdGhpcyBmdW5jdGlvbiBpcyBkZWZpbmVkLlxuICAgKlxuICAgKiBFeGFtcGxlOlxuICAgKiBJZiBlbnRyeSBpcyBgLi9zY2hlZHVsZWQtZGItYmFja3VwLnRzYCB0aGUgbmFtZSB3aWxsIGRlZmF1bHQgdG8gXCJzY2hlZHVsZWQtZGItYmFja3VwXCJcbiAgICogSWYgZW50cnkgaXMgbm90IHNldCBhbmQgdGhlIGZ1bmN0aW9uIGlzIGRlZmluZWQgaW4gYGFtcGxpZnkvZnVuY3Rpb25zL2RiLWJhY2t1cC9yZXNvdXJjZS50c2AgdGhlIG5hbWUgd2lsbCBkZWZhdWx0IHRvIFwiZGItYmFja3VwXCJcbiAgICovXG4gIG5hbWU/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB0aGUgZmlsZSB0aGF0IGNvbnRhaW5zIHRoZSBmdW5jdGlvbiBlbnRyeSBwb2ludC5cbiAgICogSWYgdGhpcyBpcyBhIHJlbGF0aXZlIHBhdGgsIGl0IGlzIGNvbXB1dGVkIHJlbGF0aXZlIHRvIHRoZSBmaWxlIHdoZXJlIHRoaXMgZnVuY3Rpb24gaXMgZGVmaW5lZFxuICAgKlxuICAgKiBEZWZhdWx0cyB0byAnLi9oYW5kbGVyLnRzJ1xuICAgKi9cbiAgZW50cnk/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEFuIGFtb3VudCBvZiB0aW1lIGluIHNlY29uZHMgYmV0d2VlbiAxIHNlY29uZCBhbmQgMTUgbWludXRlcy5cbiAgICogTXVzdCBiZSBhIHdob2xlIG51bWJlci5cbiAgICogRGVmYXVsdCBpcyAzIHNlY29uZHMuXG4gICAqL1xuICB0aW1lb3V0U2Vjb25kcz86IG51bWJlcjtcblxuICAvKipcbiAgICogQW4gYW1vdW50IG9mIG1lbW9yeSAoUkFNKSB0byBhbGxvY2F0ZSB0byB0aGUgZnVuY3Rpb24gYmV0d2VlbiAxMjggYW5kIDEwMjQwIE1CLlxuICAgKiBNdXN0IGJlIGEgd2hvbGUgbnVtYmVyLlxuICAgKiBEZWZhdWx0IGlzIDUxMk1CLlxuICAgKi9cbiAgbWVtb3J5TUI/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBzaXplIG9mIHRoZSBmdW5jdGlvbidzIC90bXAgZGlyZWN0b3J5IGluIE1CLlxuICAgKiBNdXN0IGJlIGEgd2hvbGUgbnVtYmVyLlxuICAgKiBAZGVmYXVsdCA1MTJcbiAgICovXG4gIGVwaGVtZXJhbFN0b3JhZ2VTaXplTUI/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIEVudmlyb25tZW50IHZhcmlhYmxlcyB0aGF0IHdpbGwgYmUgYXZhaWxhYmxlIGR1cmluZyBmdW5jdGlvbiBleGVjdXRpb25cbiAgICovXG4gIGVudmlyb25tZW50PzogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgQmFja2VuZFNlY3JldD47XG5cbiAgLyoqXG4gICAqIE5vZGUgcnVudGltZSB2ZXJzaW9uIGZvciB0aGUgbGFtYmRhIGVudmlyb25tZW50LlxuICAgKlxuICAgKiBEZWZhdWx0cyB0byB0aGUgb2xkZXN0IE5vZGVKUyBMVFMgdmVyc2lvbi4gU2VlIGh0dHBzOi8vbm9kZWpzLm9yZy9lbi9hYm91dC9wcmV2aW91cy1yZWxlYXNlc1xuICAgKi9cbiAgcnVudGltZT86IE5vZGVWZXJzaW9uO1xuXG4gIC8qKlxuICAgKiBUaGUgYXJjaGl0ZWN0dXJlIG9mIHRoZSB0YXJnZXQgcGxhdGZvcm0gZm9yIHRoZSBsYW1iZGEgZW52aXJvbm1lbnQuXG4gICAqIERlZmF1bHRzIHRvIFg4Nl82NC5cbiAgICovXG4gIGFyY2hpdGVjdHVyZT86IEZ1bmN0aW9uQXJjaGl0ZWN0dXJlO1xuXG4gIC8qKlxuICAgKiBBIHRpbWUgaW50ZXJ2YWwgc3RyaW5nIHRvIHBlcmlvZGljYWxseSBydW4gdGhlIGZ1bmN0aW9uLlxuICAgKiBUaGlzIGNhbiBiZSBlaXRoZXIgYSBzdHJpbmcgb2YgYFwiZXZlcnkgPHBvc2l0aXZlIHdob2xlIG51bWJlcj48bSAobWludXRlKSBvciBoIChob3VyKT5cImAsIGBcImV2ZXJ5IGRheXx3ZWVrfG1vbnRofHllYXJcImAgb3IgY3JvbiBleHByZXNzaW9uLlxuICAgKiBEZWZhdWx0cyB0byBubyBzY2hlZHVsaW5nIGZvciB0aGUgZnVuY3Rpb24uXG4gICAqIEBleGFtcGxlXG4gICAqIHNjaGVkdWxlOiBcImV2ZXJ5IDVtXCJcbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiZXZlcnkgd2Vla1wiXG4gICAqIEBleGFtcGxlXG4gICAqIHNjaGVkdWxlOiBcIjAgOSA/ICogMiAqXCIgLy8gZXZlcnkgTW9uZGF5IGF0IDlhbVxuICAgKi9cbiAgc2NoZWR1bGU/OiBGdW5jdGlvblNjaGVkdWxlIHwgRnVuY3Rpb25TY2hlZHVsZVtdO1xuXG4gIC8qKlxuICAgKiBBdHRhY2ggTGFtYmRhIGxheWVycyB0byBhIGZ1bmN0aW9uXG4gICAqIC0gQSBMYW1iZGEgbGF5ZXIgaXMgcmVwcmVzZW50ZWQgYnkgYW4gb2JqZWN0IG9mIGtleS92YWx1ZSBwYWlyIHdoZXJlIHRoZSBrZXkgaXMgdGhlIG1vZHVsZSBuYW1lIHRoYXQgaXMgZXhwb3J0ZWQgZnJvbSB5b3VyIGxheWVyIGFuZCB0aGUgdmFsdWUgaXMgdGhlIEFSTiBvZiB0aGUgbGF5ZXIuIFRoZSBrZXkgKG1vZHVsZSBuYW1lKSBpcyB1c2VkIHRvIGV4dGVybmFsaXplIHRoZSBtb2R1bGUgZGVwZW5kZW5jeSBzbyBpdCBkb2Vzbid0IGdldCBidW5kbGVkIHdpdGggeW91ciBsYW1iZGEgZnVuY3Rpb25cbiAgICogLSBNYXhpbXVtIG9mIDUgbGF5ZXJzIGNhbiBiZSBhdHRhY2hlZCB0byBhIGZ1bmN0aW9uIGFuZCBtdXN0IGJlIGluIHRoZSBzYW1lIHJlZ2lvbiBhcyB0aGUgZnVuY3Rpb24uXG4gICAqIEBleGFtcGxlXG4gICAqIGxheWVyczoge1xuICAgKiAgICBcIkBhd3MtbGFtYmRhLXBvd2VydG9vbHMvbG9nZ2VyXCI6IFwiYXJuOmF3czpsYW1iZGE6PGN1cnJlbnQtcmVnaW9uPjowOTQyNzQxMDU5MTU6bGF5ZXI6QVdTTGFtYmRhUG93ZXJ0b29sc1R5cGVTY3JpcHRWMjoxMVwiXG4gICAqIH0sXG4gICAqIG9yXG4gICAqIEBleGFtcGxlXG4gICAqIGxheWVyczoge1xuICAgKiAgICBcIlNoYXJwXCI6IFwiU2hhcnBMYXllcjoxXCJcbiAgICogfSxcbiAgICogQHNlZSBbQW1wbGlmeSBkb2N1bWVudGF0aW9uIGZvciBMYW1iZGEgbGF5ZXJzXShodHRwczovL2RvY3MuYW1wbGlmeS5hd3MvcmVhY3QvYnVpbGQtYS1iYWNrZW5kL2Z1bmN0aW9ucy9hZGQtbGFtYmRhLWxheWVycylcbiAgICogQHNlZSBbQVdTIGRvY3VtZW50YXRpb24gZm9yIExhbWJkYSBsYXllcnNdKGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9sYW1iZGEvbGF0ZXN0L2RnL2NoYXB0ZXItbGF5ZXJzLmh0bWwpXG4gICAqL1xuICBsYXllcnM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuXG4gIC8qXG4gICAqIE9wdGlvbnMgZm9yIGJ1bmRsaW5nIHRoZSBmdW5jdGlvbiBjb2RlLlxuICAgKi9cbiAgYnVuZGxpbmc/OiBGdW5jdGlvbkJ1bmRsaW5nT3B0aW9ucztcblxuICAvKipcbiAgICogR3JvdXAgdGhlIGZ1bmN0aW9uIHdpdGggZXhpc3RpbmcgQW1wbGlmeSByZXNvdXJjZXMgb3Igc2VwYXJhdGUgdGhlIGZ1bmN0aW9uIGludG8gaXRzIG93biBncm91cC5cbiAgICogQGRlZmF1bHQgJ2Z1bmN0aW9uJyAvLyBncm91cGluZyB3aXRoIG90aGVyIEFtcGxpZnkgZnVuY3Rpb25zXG4gICAqIEBleGFtcGxlXG4gICAqIHJlc291cmNlR3JvdXBOYW1lOiAnYXV0aCcgLy8gdG8gZ3JvdXAgYW4gYXV0aCB0cmlnZ2VyIHdpdGggYW4gYXV0aCByZXNvdXJjZVxuICAgKi9cbiAgcmVzb3VyY2VHcm91cE5hbWU/OiBBbXBsaWZ5UmVzb3VyY2VHcm91cE5hbWU7XG5cbiAgbG9nZ2luZz86IEZ1bmN0aW9uTG9nZ2luZ09wdGlvbnM7XG59O1xuXG5leHBvcnQgdHlwZSBGdW5jdGlvbkJ1bmRsaW5nT3B0aW9ucyA9IHtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gbWluaWZ5IHRoZSBmdW5jdGlvbiBjb2RlLlxuICAgKlxuICAgKiBEZWZhdWx0cyB0byB0cnVlLlxuICAgKi9cbiAgbWluaWZ5PzogYm9vbGVhbjtcbn07XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uTG9nZ2luZ09wdGlvbnMgPSAoXG4gIHwge1xuICAgICAgZm9ybWF0OiAnanNvbic7XG4gICAgICBsZXZlbD86IEZ1bmN0aW9uTG9nTGV2ZWw7XG4gICAgfVxuICB8IHtcbiAgICAgIGZvcm1hdD86ICd0ZXh0JztcbiAgICB9XG4pICYge1xuICByZXRlbnRpb24/OiBGdW5jdGlvbkxvZ1JldGVudGlvbjtcbn07XG5cbi8qKlxuICogQ3JlYXRlIExhbWJkYSBmdW5jdGlvbnMgaW4gdGhlIGNvbnRleHQgb2YgYW4gQW1wbGlmeSBiYWNrZW5kIGRlZmluaXRpb25cbiAqL1xuY2xhc3MgRnVuY3Rpb25GYWN0b3J5IGltcGxlbWVudHMgQ29uc3RydWN0RmFjdG9yeTxBbXBsaWZ5RnVuY3Rpb24+IHtcbiAgcHJpdmF0ZSBnZW5lcmF0b3I6IENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yO1xuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IEFtcGxpZnlGdW5jdGlvbkZhY3RvcnlcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEZ1bmN0aW9uUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjYWxsZXJTdGFjaz86IHN0cmluZyxcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuIGluc3RhbmNlIG9mIEFtcGxpZnlGdW5jdGlvbiB3aXRoaW4gdGhlIHByb3ZpZGVkIEFtcGxpZnkgY29udGV4dFxuICAgKi9cbiAgZ2V0SW5zdGFuY2UgPSAoe1xuICAgIGNvbnN0cnVjdENvbnRhaW5lcixcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yLFxuICB9OiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyk6IEFtcGxpZnlGdW5jdGlvbiA9PiB7XG4gICAgaWYgKCF0aGlzLmdlbmVyYXRvcikge1xuICAgICAgdGhpcy5nZW5lcmF0b3IgPSBuZXcgRnVuY3Rpb25HZW5lcmF0b3IoXG4gICAgICAgIHRoaXMuaHlkcmF0ZURlZmF1bHRzKHJlc291cmNlTmFtZVZhbGlkYXRvciksXG4gICAgICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBjb25zdHJ1Y3RDb250YWluZXIuZ2V0T3JDb21wdXRlKHRoaXMuZ2VuZXJhdG9yKSBhcyBBbXBsaWZ5RnVuY3Rpb247XG4gIH07XG5cbiAgcHJpdmF0ZSBoeWRyYXRlRGVmYXVsdHMgPSAoXG4gICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yPzogUmVzb3VyY2VOYW1lVmFsaWRhdG9yLFxuICApOiBIeWRyYXRlZEZ1bmN0aW9uUHJvcHMgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSB0aGlzLnJlc29sdmVOYW1lKCk7XG4gICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yPy52YWxpZGF0ZShuYW1lKTtcblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lLFxuICAgICAgZW50cnk6IHRoaXMucmVzb2x2ZUVudHJ5KCksXG4gICAgICB0aW1lb3V0U2Vjb25kczogdGhpcy5yZXNvbHZlVGltZW91dCgpLFxuICAgICAgbWVtb3J5TUI6IHRoaXMucmVzb2x2ZU1lbW9yeSgpLFxuICAgICAgZXBoZW1lcmFsU3RvcmFnZVNpemVNQjogdGhpcy5yZXNvbHZlRXBoZW1lcmFsU3RvcmFnZVNpemUoKSxcbiAgICAgIGVudmlyb25tZW50OiB0aGlzLnJlc29sdmVFbnZpcm9ubWVudCgpLFxuICAgICAgcnVudGltZTogdGhpcy5yZXNvbHZlUnVudGltZSgpLFxuICAgICAgYXJjaGl0ZWN0dXJlOiB0aGlzLnJlc29sdmVBcmNoaXRlY3R1cmUoKSxcbiAgICAgIHNjaGVkdWxlOiB0aGlzLnJlc29sdmVTY2hlZHVsZSgpLFxuICAgICAgYnVuZGxpbmc6IHRoaXMucmVzb2x2ZUJ1bmRsaW5nKCksXG4gICAgICBsYXllcnM6IHRoaXMucHJvcHMubGF5ZXJzID8/IHt9LFxuICAgICAgcmVzb3VyY2VHcm91cE5hbWU6IHRoaXMucHJvcHMucmVzb3VyY2VHcm91cE5hbWUgPz8gJ2Z1bmN0aW9uJyxcbiAgICAgIGxvZ2dpbmc6IHRoaXMucHJvcHMubG9nZ2luZyA/PyB7fSxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU5hbWUgPSAoKSA9PiB7XG4gICAgLy8gSWYgbmFtZSBpcyBzZXQgZXhwbGljaXRseSwgdXNlIHRoYXRcbiAgICBpZiAodGhpcy5wcm9wcy5uYW1lKSB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5uYW1lO1xuICAgIH1cbiAgICAvLyBJZiBlbnRyeSBpcyBzZXQsIHVzZSB0aGUgYmFzZW5hbWUgb2YgdGhlIGVudHJ5IHBhdGhcbiAgICBpZiAodGhpcy5wcm9wcy5lbnRyeSkge1xuICAgICAgcmV0dXJuIHBhdGgucGFyc2UodGhpcy5wcm9wcy5lbnRyeSkubmFtZTtcbiAgICB9XG5cbiAgICAvLyBPdGhlcndpc2UsIHVzZSB0aGUgZGlyZWN0b3J5IG5hbWUgd2hlcmUgdGhlIGZ1bmN0aW9uIGlzIGRlZmluZWRcbiAgICByZXR1cm4gcGF0aC5iYXNlbmFtZShcbiAgICAgIG5ldyBDYWxsZXJEaXJlY3RvcnlFeHRyYWN0b3IodGhpcy5jYWxsZXJTdGFjaykuZXh0cmFjdCgpLFxuICAgICk7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlRW50cnkgPSAoKSA9PiB7XG4gICAgLy8gaWYgZW50cnkgaXMgbm90IHNldCwgZGVmYXVsdCB0byBoYW5kbGVyLnRzXG4gICAgaWYgKCF0aGlzLnByb3BzLmVudHJ5KSB7XG4gICAgICByZXR1cm4gcGF0aC5qb2luKFxuICAgICAgICBuZXcgQ2FsbGVyRGlyZWN0b3J5RXh0cmFjdG9yKHRoaXMuY2FsbGVyU3RhY2spLmV4dHJhY3QoKSxcbiAgICAgICAgJ2hhbmRsZXIudHMnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBpZiBlbnRyeSBpcyBhYnNvbHV0ZSB1c2UgdGhhdFxuICAgIGlmIChwYXRoLmlzQWJzb2x1dGUodGhpcy5wcm9wcy5lbnRyeSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnByb3BzLmVudHJ5O1xuICAgIH1cblxuICAgIC8vIGlmIGVudHJ5IGlzIHJlbGF0aXZlLCBjb21wdXRlIHdpdGggcmVzcGVjdCB0byB0aGUgY2FsbGVyIGRpcmVjdG9yeVxuICAgIHJldHVybiBwYXRoLmpvaW4oXG4gICAgICBuZXcgQ2FsbGVyRGlyZWN0b3J5RXh0cmFjdG9yKHRoaXMuY2FsbGVyU3RhY2spLmV4dHJhY3QoKSxcbiAgICAgIHRoaXMucHJvcHMuZW50cnksXG4gICAgKTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVUaW1lb3V0ID0gKCkgPT4ge1xuICAgIGNvbnN0IHRpbWVvdXRNaW4gPSAxO1xuICAgIGNvbnN0IHRpbWVvdXRNYXggPSA2MCAqIDE1OyAvLyAxNSBtaW51dGVzIGluIHNlY29uZHNcbiAgICBjb25zdCB0aW1lb3V0RGVmYXVsdCA9IDM7XG4gICAgaWYgKHRoaXMucHJvcHMudGltZW91dFNlY29uZHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHRpbWVvdXREZWZhdWx0O1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShcbiAgICAgICAgdGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kcyxcbiAgICAgICAgdGltZW91dE1pbixcbiAgICAgICAgdGltZW91dE1heCxcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkVGltZW91dEVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBmdW5jdGlvbiB0aW1lb3V0IG9mICR7dGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kc31gLFxuICAgICAgICByZXNvbHV0aW9uOiBgdGltZW91dFNlY29uZHMgbXVzdCBiZSBhIHdob2xlIG51bWJlciBiZXR3ZWVuICR7dGltZW91dE1pbn0gYW5kICR7dGltZW91dE1heH0gaW5jbHVzaXZlYCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kcztcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVNZW1vcnkgPSAoKSA9PiB7XG4gICAgY29uc3QgbWVtb3J5TWluID0gMTI4O1xuICAgIGNvbnN0IG1lbW9yeU1heCA9IDEwMjQwO1xuICAgIGNvbnN0IG1lbW9yeURlZmF1bHQgPSA1MTI7XG4gICAgaWYgKHRoaXMucHJvcHMubWVtb3J5TUIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIG1lbW9yeURlZmF1bHQ7XG4gICAgfVxuICAgIGlmIChcbiAgICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZSh0aGlzLnByb3BzLm1lbW9yeU1CLCBtZW1vcnlNaW4sIG1lbW9yeU1heClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkTWVtb3J5TUJFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gbWVtb3J5TUIgb2YgJHt0aGlzLnByb3BzLm1lbW9yeU1CfWAsXG4gICAgICAgIHJlc29sdXRpb246IGBtZW1vcnlNQiBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHttZW1vcnlNaW59IGFuZCAke21lbW9yeU1heH0gaW5jbHVzaXZlYCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5tZW1vcnlNQjtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVFcGhlbWVyYWxTdG9yYWdlU2l6ZSA9ICgpID0+IHtcbiAgICBjb25zdCBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1pbiA9IDUxMjtcbiAgICBjb25zdCBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1heCA9IDEwMjQwO1xuICAgIGNvbnN0IGVwaGVtZXJhbFN0b3JhZ2VTaXplRGVmYXVsdCA9IDUxMjtcbiAgICBpZiAodGhpcy5wcm9wcy5lcGhlbWVyYWxTdG9yYWdlU2l6ZU1CID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBlcGhlbWVyYWxTdG9yYWdlU2l6ZURlZmF1bHQ7XG4gICAgfVxuICAgIGlmIChcbiAgICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShcbiAgICAgICAgdGhpcy5wcm9wcy5lcGhlbWVyYWxTdG9yYWdlU2l6ZU1CLFxuICAgICAgICBlcGhlbWVyYWxTdG9yYWdlU2l6ZU1pbixcbiAgICAgICAgZXBoZW1lcmFsU3RvcmFnZVNpemVNYXgsXG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZEVwaGVtZXJhbFN0b3JhZ2VTaXplTUJFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gZXBoZW1lcmFsU3RvcmFnZVNpemVNQiBvZiAke3RoaXMucHJvcHMuZXBoZW1lcmFsU3RvcmFnZVNpemVNQn1gLFxuICAgICAgICByZXNvbHV0aW9uOiBgZXBoZW1lcmFsU3RvcmFnZVNpemVNQiBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHtlcGhlbWVyYWxTdG9yYWdlU2l6ZU1pbn0gYW5kICR7ZXBoZW1lcmFsU3RvcmFnZVNpemVNYXh9IGluY2x1c2l2ZWAsXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJvcHMuZXBoZW1lcmFsU3RvcmFnZVNpemVNQjtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVFbnZpcm9ubWVudCA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5wcm9wcy5lbnZpcm9ubWVudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgY29uc3QgaW52YWxpZEtleXM6IHN0cmluZ1tdID0gW107XG5cbiAgICBPYmplY3Qua2V5cyh0aGlzLnByb3BzLmVudmlyb25tZW50KS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIC8vIHZhbGlkYXRlIHVzaW5nIGtleSBwYXR0ZXJuIGZyb20gaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2xhbWJkYS9sYXRlc3QvYXBpL0FQSV9FbnZpcm9ubWVudC5odG1sXG4gICAgICBpZiAoIWtleS5tYXRjaCgvXlthLXpBLVpdKFthLXpBLVowLTlfXSkrJC8pKSB7XG4gICAgICAgIGludmFsaWRLZXlzLnB1c2goa2V5KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChpbnZhbGlkS2V5cy5sZW5ndGggPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZEVudmlyb25tZW50S2V5RXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIGZ1bmN0aW9uIGVudmlyb25tZW50IGtleShzKTogJHtpbnZhbGlkS2V5cy5qb2luKFxuICAgICAgICAgICcsICcsXG4gICAgICAgICl9YCxcbiAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAnRW52aXJvbm1lbnQga2V5cyBtdXN0IG1hdGNoIFthLXpBLVpdKFthLXpBLVowLTlfXSkrIGFuZCBiZSBhdCBsZWFzdCAyIGNoYXJhY3RlcnMnLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMuZW52aXJvbm1lbnQ7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlUnVudGltZSA9ICgpID0+IHtcbiAgICBjb25zdCBydW50aW1lRGVmYXVsdCA9IDIwO1xuXG4gICAgLy8gaWYgcnVudGltZSBpcyBub3Qgc2V0LCBkZWZhdWx0IHRvIHRoZSBvbGRlc3QgTFRTXG4gICAgaWYgKCF0aGlzLnByb3BzLnJ1bnRpbWUpIHtcbiAgICAgIHJldHVybiBydW50aW1lRGVmYXVsdDtcbiAgICB9XG5cbiAgICBpZiAoISh0aGlzLnByb3BzLnJ1bnRpbWUgaW4gbm9kZVZlcnNpb25NYXApKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZFJ1bnRpbWVFcnJvcicsIHtcbiAgICAgICAgbWVzc2FnZTogYEludmFsaWQgZnVuY3Rpb24gcnVudGltZSBvZiAke3RoaXMucHJvcHMucnVudGltZX1gLFxuICAgICAgICByZXNvbHV0aW9uOiBgcnVudGltZSBtdXN0IGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nOiAke09iamVjdC5rZXlzKFxuICAgICAgICAgIG5vZGVWZXJzaW9uTWFwLFxuICAgICAgICApLmpvaW4oJywgJyl9YCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb3BzLnJ1bnRpbWU7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlQXJjaGl0ZWN0dXJlID0gKCkgPT4ge1xuICAgIGNvbnN0IGFyY2hpdGVjdHVyZURlZmF1bHQgPSAneDg2XzY0JztcblxuICAgIGlmICghdGhpcy5wcm9wcy5hcmNoaXRlY3R1cmUpIHtcbiAgICAgIHJldHVybiBhcmNoaXRlY3R1cmVEZWZhdWx0O1xuICAgIH1cblxuICAgIGlmICghKHRoaXMucHJvcHMuYXJjaGl0ZWN0dXJlIGluIGFyY2hpdGVjdHVyZU1hcCkpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkQXJjaGl0ZWN0dXJlRXJyb3InLCB7XG4gICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIGZ1bmN0aW9uIGFyY2hpdGVjdHVyZSBvZiAke3RoaXMucHJvcHMuYXJjaGl0ZWN0dXJlfWAsXG4gICAgICAgIHJlc29sdXRpb246IGBhcmNoaXRlY3R1cmUgbXVzdCBiZSBvbmUgb2YgdGhlIGZvbGxvd2luZzogJHtPYmplY3Qua2V5cyhcbiAgICAgICAgICBhcmNoaXRlY3R1cmVNYXAsXG4gICAgICAgICkuam9pbignLCAnKX1gLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvcHMuYXJjaGl0ZWN0dXJlO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVNjaGVkdWxlID0gKCkgPT4ge1xuICAgIGlmICghdGhpcy5wcm9wcy5zY2hlZHVsZSkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb3BzLnNjaGVkdWxlO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUJ1bmRsaW5nID0gKCkgPT4ge1xuICAgIGNvbnN0IGJ1bmRsaW5nRGVmYXVsdCA9IHtcbiAgICAgIGZvcm1hdDogT3V0cHV0Rm9ybWF0LkVTTSxcbiAgICAgIGJ1bmRsZUF3c1NESzogdHJ1ZSxcbiAgICAgIGxvYWRlcjoge1xuICAgICAgICAnLm5vZGUnOiAnZmlsZScsXG4gICAgICB9LFxuICAgICAgbWluaWZ5OiB0cnVlLFxuICAgICAgc291cmNlTWFwOiB0cnVlLFxuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4uYnVuZGxpbmdEZWZhdWx0LFxuICAgICAgbWluaWZ5OiB0aGlzLnJlc29sdmVNaW5pZnkodGhpcy5wcm9wcy5idW5kbGluZyksXG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVNaW5pZnkgPSAoYnVuZGxpbmc/OiBGdW5jdGlvbkJ1bmRsaW5nT3B0aW9ucykgPT4ge1xuICAgIHJldHVybiBidW5kbGluZz8ubWluaWZ5ID09PSB1bmRlZmluZWQgPyB0cnVlIDogYnVuZGxpbmcubWluaWZ5O1xuICB9O1xufVxuXG50eXBlIEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyA9IFJlcXVpcmVkPEZ1bmN0aW9uUHJvcHM+O1xuXG5jbGFzcyBGdW5jdGlvbkdlbmVyYXRvciBpbXBsZW1lbnRzIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yIHtcbiAgcmVhZG9ubHkgcmVzb3VyY2VHcm91cE5hbWU6IEFtcGxpZnlSZXNvdXJjZUdyb3VwTmFtZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBIeWRyYXRlZEZ1bmN0aW9uUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8RnVuY3Rpb25PdXRwdXQ+LFxuICApIHtcbiAgICB0aGlzLnJlc291cmNlR3JvdXBOYW1lID0gcHJvcHMucmVzb3VyY2VHcm91cE5hbWU7XG4gIH1cblxuICBnZW5lcmF0ZUNvbnRhaW5lckVudHJ5ID0gKHtcbiAgICBzY29wZSxcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIH06IEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcykgPT4ge1xuICAgIC8vIE1vdmUgbGF5ZXIgcmVzb2x1dGlvbiBoZXJlIHdoZXJlIHdlIGhhdmUgYWNjZXNzIHRvIHNjb3BlXG4gICAgY29uc3QgcGFyc2VyID0gbmV3IEZ1bmN0aW9uTGF5ZXJBcm5QYXJzZXIoXG4gICAgICBTdGFjay5vZihzY29wZSkucmVnaW9uLFxuICAgICAgU3RhY2sub2Yoc2NvcGUpLmFjY291bnQsXG4gICAgKTtcbiAgICBjb25zdCByZXNvbHZlZExheWVyQXJucyA9IHBhcnNlci5wYXJzZUxheWVycyhcbiAgICAgIHRoaXMucHJvcHMubGF5ZXJzID8/IHt9LFxuICAgICAgdGhpcy5wcm9wcy5uYW1lLFxuICAgICk7XG5cbiAgICAvLyByZXNvbHZlIGxheWVycyB0byBMYXllclZlcnNpb24gb2JqZWN0cyBmb3IgdGhlIE5vZGVqc0Z1bmN0aW9uIGNvbnN0cnVjdG9yXG4gICAgY29uc3QgcmVzb2x2ZWRMYXllcnMgPSBPYmplY3QuZW50cmllcyhyZXNvbHZlZExheWVyQXJucykubWFwKChba2V5LCBhcm5dKSA9PlxuICAgICAgTGF5ZXJWZXJzaW9uLmZyb21MYXllclZlcnNpb25Bcm4oXG4gICAgICAgIHNjb3BlLFxuICAgICAgICBgJHt0aGlzLnByb3BzLm5hbWV9LSR7a2V5fS1sYXllcmAsXG4gICAgICAgIGFybixcbiAgICAgICksXG4gICAgKTtcblxuICAgIHJldHVybiBuZXcgQW1wbGlmeUZ1bmN0aW9uKFxuICAgICAgc2NvcGUsXG4gICAgICB0aGlzLnByb3BzLm5hbWUsXG4gICAgICB7IC4uLnRoaXMucHJvcHMsIHJlc29sdmVkTGF5ZXJzIH0sXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICB0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICApO1xuICB9O1xufVxuXG5jbGFzcyBBbXBsaWZ5RnVuY3Rpb25cbiAgZXh0ZW5kcyBBbXBsaWZ5RnVuY3Rpb25CYXNlXG4gIGltcGxlbWVudHMgQWRkRW52aXJvbm1lbnRGYWN0b3J5XG57XG4gIHJlYWRvbmx5IHJlc291cmNlczogRnVuY3Rpb25SZXNvdXJjZXM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3I6IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yO1xuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyAmIHsgcmVzb2x2ZWRMYXllcnM6IElMYXllclZlcnNpb25bXSB9LFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcjogQmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxGdW5jdGlvbk91dHB1dD4sXG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5KTtcblxuICAgIGNvbnN0IHJ1bnRpbWUgPSBub2RlVmVyc2lvbk1hcFtwcm9wcy5ydW50aW1lXTtcblxuICAgIGNvbnN0IHJlcXVpcmUgPSBjcmVhdGVSZXF1aXJlKGltcG9ydC5tZXRhLnVybCk7XG5cbiAgICBjb25zdCBzaGltcyA9XG4gICAgICBydW50aW1lID09PSBSdW50aW1lLk5PREVKU18xNl9YXG4gICAgICAgID8gW11cbiAgICAgICAgOiBbcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9janNfc2hpbScpXTtcblxuICAgIGNvbnN0IHNzbVJlc29sdmVyRmlsZSA9XG4gICAgICBydW50aW1lID09PSBSdW50aW1lLk5PREVKU18xNl9YXG4gICAgICAgID8gcmVxdWlyZS5yZXNvbHZlKCcuL2xhbWJkYS1zaGltcy9yZXNvbHZlX3NzbV9wYXJhbXNfc2RrX3YyJykgLy8gdXNlIGF3cyBjZGsgdjIgaW4gbm9kZSAxNlxuICAgICAgICA6IHJlcXVpcmUucmVzb2x2ZSgnLi9sYW1iZGEtc2hpbXMvcmVzb2x2ZV9zc21fcGFyYW1zJyk7XG5cbiAgICBjb25zdCBpbnZva2VTc21SZXNvbHZlckZpbGUgPSByZXF1aXJlLnJlc29sdmUoXG4gICAgICAnLi9sYW1iZGEtc2hpbXMvaW52b2tlX3NzbV9zaGltJyxcbiAgICApO1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBjb2RlIGNvbmNhdGVuYXRlcyB0aGUgY29udGVudHMgb2YgdGhlIHNzbSByZXNvbHZlciBhbmQgaW52b2tlciBpbnRvIGEgc2luZ2xlIGxpbmUgdGhhdCBjYW4gYmUgdXNlZCBhcyB0aGUgZXNidWlsZCBiYW5uZXIgY29udGVudFxuICAgICAqIFRoaXMgYmFubmVyIGlzIHJlc3BvbnNpYmxlIGZvciByZXNvbHZpbmcgdGhlIGN1c3RvbWVyJ3MgU1NNIHBhcmFtZXRlcnMgYXQgcnVudGltZVxuICAgICAqL1xuICAgIGNvbnN0IGJhbm5lckNvZGUgPSByZWFkRmlsZVN5bmMoc3NtUmVzb2x2ZXJGaWxlLCAndXRmLTgnKVxuICAgICAgLmNvbmNhdChyZWFkRmlsZVN5bmMoaW52b2tlU3NtUmVzb2x2ZXJGaWxlLCAndXRmLTgnKSlcbiAgICAgIC5zcGxpdChuZXcgUmVnRXhwKGAke0VPTH18XFxufFxccmAsICdnJykpXG4gICAgICAubWFwKChsaW5lKSA9PiBsaW5lLnJlcGxhY2UoL1xcL1xcLy4qJC8sICcnKSkgLy8gc3RyaXAgb3V0IGlubGluZSBjb21tZW50cyBiZWNhdXNlIHRoZSBiYW5uZXIgaXMgZ29pbmcgdG8gYmUgZmxhdHRlbmVkIGludG8gYSBzaW5nbGUgbGluZVxuICAgICAgLmpvaW4oJycpO1xuXG4gICAgY29uc3QgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IgPVxuICAgICAgbmV3IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yKGlkKTtcblxuICAgIC8vIGVzYnVpbGQgcnVucyBhcyBwYXJ0IG9mIHRoZSBOb2RlanNGdW5jdGlvbiBjb25zdHJ1Y3Rvciwgc28gd2UgZWFnZXJseSBnZW5lcmF0ZSB0aGUgcHJvY2VzcyBlbnYgc2hpbSB3aXRob3V0IHR5cGVzIHNvIGl0IGNhbiBiZSBpbmNsdWRlZCBpbiB0aGUgZnVuY3Rpb24gYnVuZGxlLlxuICAgIC8vIFRoaXMgd2lsbCBiZSBvdmVyd3JpdHRlbiB3aXRoIHRoZSB0eXBlZCBmaWxlIGF0IHRoZSBlbmQgb2Ygc3ludGhlc2lzXG4gICAgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IuZ2VuZXJhdGVQcm9jZXNzRW52U2hpbSgpO1xuXG4gICAgbGV0IGZ1bmN0aW9uTGFtYmRhOiBOb2RlanNGdW5jdGlvbjtcbiAgICBjb25zdCBjZGtMb2dnaW5nT3B0aW9ucyA9IGNvbnZlcnRMb2dnaW5nT3B0aW9uc1RvQ0RLKHByb3BzLmxvZ2dpbmcpO1xuICAgIHRyeSB7XG4gICAgICBmdW5jdGlvbkxhbWJkYSA9IG5ldyBOb2RlanNGdW5jdGlvbihzY29wZSwgYCR7aWR9LWxhbWJkYWAsIHtcbiAgICAgICAgZW50cnk6IHByb3BzLmVudHJ5LFxuICAgICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKHByb3BzLnRpbWVvdXRTZWNvbmRzKSxcbiAgICAgICAgbWVtb3J5U2l6ZTogcHJvcHMubWVtb3J5TUIsXG4gICAgICAgIGFyY2hpdGVjdHVyZTogYXJjaGl0ZWN0dXJlTWFwW3Byb3BzLmFyY2hpdGVjdHVyZV0sXG4gICAgICAgIGVwaGVtZXJhbFN0b3JhZ2VTaXplOiBTaXplLm1lYmlieXRlcyhwcm9wcy5lcGhlbWVyYWxTdG9yYWdlU2l6ZU1CKSxcbiAgICAgICAgcnVudGltZTogbm9kZVZlcnNpb25NYXBbcHJvcHMucnVudGltZV0sXG4gICAgICAgIGxheWVyczogcHJvcHMucmVzb2x2ZWRMYXllcnMsXG4gICAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgICAgLi4ucHJvcHMuYnVuZGxpbmcsXG4gICAgICAgICAgYmFubmVyOiBiYW5uZXJDb2RlLFxuICAgICAgICAgIGluamVjdDogc2hpbXMsXG4gICAgICAgICAgZXh0ZXJuYWxNb2R1bGVzOiBPYmplY3Qua2V5cyhwcm9wcy5sYXllcnMpLFxuICAgICAgICAgIGxvZ0xldmVsOiBFc0J1aWxkTG9nTGV2ZWwuRVJST1IsXG4gICAgICAgIH0sXG4gICAgICAgIGxvZ1JldGVudGlvbjogY2RrTG9nZ2luZ09wdGlvbnMucmV0ZW50aW9uLFxuICAgICAgICBhcHBsaWNhdGlvbkxvZ0xldmVsVjI6IGNka0xvZ2dpbmdPcHRpb25zLmxldmVsLFxuICAgICAgICBsb2dnaW5nRm9ybWF0OiBjZGtMb2dnaW5nT3B0aW9ucy5mb3JtYXQsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gSWYgdGhlIGVycm9yIGlzIGZyb20gRVMgQnVuZGxlciB3aGljaCBpcyBleGVjdXRlZCBhcyBhIGNoaWxkIHByb2Nlc3MgYnkgQ0RLLFxuICAgICAgLy8gdGhlbiB0aGUgZXJyb3IgZnJvbSBDREsgY29udGFpbnMgdGhlIGNvbW1hbmQgdGhhdCB3YXMgZXhlY3V0ZWQgYWxvbmcgd2l0aCB0aGUgZXhpdCBzdGF0dXMuXG4gICAgICAvLyBXcmFwcGluZyBpdCBoZXJlICB3b3VsZCBjYXVzZSB0aGUgY2RrX2RlcGxveWVyIHRvIHJlLXRocm93IHRoaXMgd3JhcHBlZCBleGNlcHRpb25cbiAgICAgIC8vIGluc3RlYWQgb2Ygc2NyYXBpbmcgdGhlIHN0ZGVyciBmb3IgYWN0dWFsIEVTQnVpbGQgZXJyb3IuXG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiZcbiAgICAgICAgZXJyb3IubWVzc2FnZS5tYXRjaCgvRmFpbGVkIHRvIGJ1bmRsZSBhc3NldC4qZXhpdGVkIHdpdGggc3RhdHVzLylcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnTm9kZUpTRnVuY3Rpb25Db25zdHJ1Y3RJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgbm9kZWpzIGZ1bmN0aW9uIGNvbnN0cnVjdCcsXG4gICAgICAgICAgcmVzb2x1dGlvbjpcbiAgICAgICAgICAgICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLiBVc2UgYC0tZGVidWdgIGZvciBhZGRpdGlvbmFsIGRlYnVnZ2luZyBpbmZvcm1hdGlvbi4nLFxuICAgICAgICB9LFxuICAgICAgICBlcnJvciBhcyBFcnJvcixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25zID0gY29udmVydEZ1bmN0aW9uU2NoZWR1bGVzVG9TY2hlZHVsZUV4cHJlc3Npb25zKFxuICAgICAgICBmdW5jdGlvbkxhbWJkYSxcbiAgICAgICAgcHJvcHMuc2NoZWR1bGUsXG4gICAgICApO1xuXG4gICAgICBjb25zdCBsYW1iZGFUYXJnZXQgPSBuZXcgdGFyZ2V0cy5MYW1iZGFJbnZva2UoZnVuY3Rpb25MYW1iZGEpO1xuXG4gICAgICBleHByZXNzaW9ucy5mb3JFYWNoKChleHByZXNzaW9uLCBpbmRleCkgPT4ge1xuICAgICAgICAvLyBMYW1iZGEgbmFtZSB3aWxsIGJlIHByZXBlbmRlZCB0byBzY2hlZHVsZSBpZCwgc28gb25seSB1c2luZyBpbmRleCBoZXJlIGZvciB1bmlxdWVuZXNzXG4gICAgICAgIG5ldyBzY2hlZHVsZXIuU2NoZWR1bGUoZnVuY3Rpb25MYW1iZGEsIGBzY2hlZHVsZSR7aW5kZXh9YCwge1xuICAgICAgICAgIHNjaGVkdWxlOiBleHByZXNzaW9uLFxuICAgICAgICAgIHRhcmdldDogbGFtYmRhVGFyZ2V0LFxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0Z1bmN0aW9uU2NoZWR1bGVJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgc2NoZWR1bGUgZm9yIG5vZGVqcyBmdW5jdGlvbicsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3IsXG4gICAgICApO1xuICAgIH1cblxuICAgIFRhZ3Mub2YoZnVuY3Rpb25MYW1iZGEpLmFkZChUYWdOYW1lLkZSSUVORExZX05BTUUsIGlkKTtcblxuICAgIHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IgPSBuZXcgRnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IoXG4gICAgICBmdW5jdGlvbkxhbWJkYSxcbiAgICAgIHByb3BzLmVudmlyb25tZW50LFxuICAgICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICAgICAgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IsXG4gICAgKTtcblxuICAgIHRoaXMucmVzb3VyY2VzID0ge1xuICAgICAgbGFtYmRhOiBmdW5jdGlvbkxhbWJkYSxcbiAgICAgIGNmblJlc291cmNlczoge1xuICAgICAgICBjZm5GdW5jdGlvbjogZnVuY3Rpb25MYW1iZGEubm9kZS5maW5kQ2hpbGQoJ1Jlc291cmNlJykgYXMgQ2ZuRnVuY3Rpb24sXG4gICAgICB9LFxuICAgIH07XG5cbiAgICB0aGlzLnN0b3JlT3V0cHV0KCk7XG4gIH1cblxuICBhZGRFbnZpcm9ubWVudCA9IChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyB8IEJhY2tlbmRTZWNyZXQpID0+IHtcbiAgICB0aGlzLmZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yLmFkZEVudmlyb25tZW50RW50cnkoa2V5LCB2YWx1ZSk7XG4gIH07XG5cbiAgZ2V0UmVzb3VyY2VBY2Nlc3NBY2NlcHRvciA9ICgpOiBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yID0+XG4gICAgbmV3IEZ1bmN0aW9uUmVzb3VyY2VBY2Nlc3NBY2NlcHRvcihcbiAgICAgIHRoaXMsXG4gICAgICB0aGlzLmZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yLFxuICAgICk7XG59XG5cbmNvbnN0IGlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlID0gKFxuICB0ZXN0OiBudW1iZXIsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlcixcbikgPT4gbWluIDw9IHRlc3QgJiYgdGVzdCA8PSBtYXggJiYgdGVzdCAlIDEgPT09IDA7XG5cbmV4cG9ydCB0eXBlIE5vZGVWZXJzaW9uID0gMTYgfCAxOCB8IDIwIHwgMjI7XG5cbmNvbnN0IG5vZGVWZXJzaW9uTWFwOiBSZWNvcmQ8Tm9kZVZlcnNpb24sIFJ1bnRpbWU+ID0ge1xuICAxNjogUnVudGltZS5OT0RFSlNfMTZfWCxcbiAgMTg6IFJ1bnRpbWUuTk9ERUpTXzE4X1gsXG4gIDIwOiBSdW50aW1lLk5PREVKU18yMF9YLFxuICAyMjogUnVudGltZS5OT0RFSlNfMjJfWCxcbn07XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uQXJjaGl0ZWN0dXJlID0gJ3g4Nl82NCcgfCAnYXJtNjQnO1xuXG5jb25zdCBhcmNoaXRlY3R1cmVNYXA6IFJlY29yZDxGdW5jdGlvbkFyY2hpdGVjdHVyZSwgQXJjaGl0ZWN0dXJlPiA9IHtcbiAgYXJtNjQ6IEFyY2hpdGVjdHVyZS5BUk1fNjQsXG4gIHg4Nl82NDogQXJjaGl0ZWN0dXJlLlg4Nl82NCxcbn07XG4iXX0=