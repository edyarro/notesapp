import { ScheduleExpression, } from 'aws-cdk-lib/aws-scheduler';
import { TimeZone } from 'aws-cdk-lib';
import os from 'os';
const DEFAULT_TIMEZONE = 'UTC';
const hydrateDefaults = (schedule) => {
    if (typeof schedule === 'string') {
        return schedule.includes('every')
            ? { rate: schedule, timezone: DEFAULT_TIMEZONE }
            : {
                cron: schedule,
                timezone: DEFAULT_TIMEZONE,
            };
    }
    else if ('rate' in schedule) {
        return { ...schedule, timezone: schedule.timezone ?? DEFAULT_TIMEZONE };
    }
    else if ('cron' in schedule) {
        return { ...schedule, timezone: schedule.timezone ?? DEFAULT_TIMEZONE };
    }
    throw new Error("Could not determine the function's schedule type");
};
/**
 * Converts function schedules to schedule expressions.
 * @param lambda The Lambda function to associate with the schedules.
 * @param functionSchedules The function schedules to convert.
 * @returns An array of schedule expressions.
 */
export const convertFunctionSchedulesToScheduleExpressions = (lambda, functionSchedules) => {
    const errors = [];
    const scheduleExpressions = [];
    const schedules = Array.isArray(functionSchedules)
        ? functionSchedules
        : [functionSchedules];
    const zonedSchedules = schedules.map(hydrateDefaults);
    zonedSchedules.forEach((schedule) => {
        if (isTimeInterval(schedule)) {
            const { value, unit } = parseTimeInterval(schedule.rate);
            if (value && !isPositiveWholeNumber(value)) {
                errors.push('Function schedule rate must be set with a positive whole number');
            }
            else if (value &&
                lambda.timeout &&
                unit === 'm' &&
                value * 60 < lambda.timeout.toSeconds()) {
                const timeout = lambda.timeout.toSeconds();
                errors.push(`Function schedule rate must be greater than the function timeout of ${timeout} ${timeout > 1 ? 'seconds' : 'second'}`);
            }
        }
        else {
            const cronErrors = validateCron(schedule.cron);
            if (cronErrors.length > 0) {
                errors.push(...cronErrors);
            }
        }
        if (errors.length === 0) {
            scheduleExpressions.push(ScheduleExpression.cron(translateToCronOptionsWithTimezone(schedule)));
        }
    });
    if (errors.length > 0) {
        throw new Error(errors.join(os.EOL));
    }
    return scheduleExpressions;
};
const isTimeInterval = (schedule) => {
    const expression = 'rate' in schedule ? schedule.rate : '';
    const parts = expression.split(' ');
    return (parts[0] === 'every' &&
        ['m', 'h', 'day', 'week', 'month', 'year'].some((a) => parts[1].endsWith(a)) &&
        parts.length === 2);
};
const parseTimeInterval = (timeInterval) => {
    const part = timeInterval.split(' ')[1];
    const value = part.match(/-?\d+\.?\d*/);
    const unit = part.match(/[a-zA-Z]+/);
    return {
        value: value ? Number(value[0]) : undefined,
        unit: unit ? unit[0] : undefined,
    };
};
const isPositiveWholeNumber = (test) => test > 0 && test % 1 === 0;
const validateCron = (cron) => {
    const errors = [];
    const cronParts = cron.split(' ');
    const [minute, hour, dayOfMonth, month, dayOfWeek, year] = cronParts;
    const minuteValidationErrors = validateCronPart('minutes', minute, 0, 59);
    const hourValidationErrors = validateCronPart('hours', hour, 0, 23);
    const dayOfMonthValidationErrors = dayOfMonth === '?'
        ? []
        : validateCronPart('day-of-month', dayOfMonth, 1, 31);
    const monthValidationErrors = validateCronPart('month', month, 1, 12);
    const dayOfWeekValidationErrors = dayOfWeek === '?' ? [] : validateCronPart('day-of-week', dayOfWeek, 1, 7);
    const yearValidationErrors = year
        ? validateCronPart('year', year, 1970, 2199)
        : [];
    errors.push(...minuteValidationErrors, ...hourValidationErrors, ...dayOfMonthValidationErrors, ...monthValidationErrors, ...dayOfWeekValidationErrors, ...yearValidationErrors);
    if (dayOfMonth !== '?' && dayOfWeek !== '?') {
        errors.push('Cron expressions cannot have both day-of-month and day-of-week defined, you must use a ? in one of the fields');
    }
    return errors;
};
const validateCronPart = (cronPart, value, min, max) => {
    const errors = [];
    if (value === '*') {
        return errors;
    }
    const hasStep = value.includes('/');
    const hasRange = value.includes('-');
    const hasList = value.includes(',');
    if (hasList) {
        const listError = validateList(cronPart, value, min, max);
        if (listError) {
            errors.push(listError);
        }
        const listItems = value.split(',');
        listItems.forEach((listItem) => {
            if (listItem.includes('/')) {
                const stepError = validateStepValue(cronPart, listItem, min, max);
                if (stepError) {
                    errors.push(stepError);
                }
            }
            else if (listItem.includes('-')) {
                const rangeError = validateRange(cronPart, listItem, min, max);
                if (rangeError) {
                    errors.push(rangeError);
                }
            }
        });
    }
    else if (hasStep) {
        const stepError = validateStepValue(cronPart, value, min, max);
        if (stepError) {
            errors.push(stepError);
        }
    }
    else if (hasRange) {
        const rangeError = validateRange(cronPart, value, min, max);
        if (rangeError) {
            errors.push(rangeError);
        }
    }
    if (!hasStep &&
        !hasRange &&
        !hasList &&
        !isWholeNumberBetweenInclusive(Number(value), min, max)) {
        errors.push(`Cron field for ${cronPart} must be a whole number between ${min} and ${max}`);
    }
    return errors;
};
const validateStepValue = (cronPart, value, min, max) => {
    const originalBase = value.split('/')[0];
    const [base, step] = value.split('/').map(Number);
    if (originalBase === '*') {
        if (isNaN(step) || step <= 0 || !isPositiveWholeNumber(step)) {
            return `Cron step values for ${cronPart} must be positive whole numbers`;
        }
    }
    else if (isNaN(base) ||
        isNaN(step) ||
        !isWholeNumberBetweenInclusive(base, min, max) ||
        step <= 0) {
        return `Cron step values for ${cronPart} must be whole numbers between ${min} and ${max}`;
    }
    return;
};
const validateRange = (cronPart, value, min, max) => {
    const [start, end] = value.split('-').map(Number);
    if (isNaN(start) ||
        isNaN(end) ||
        !isWholeNumberBetweenInclusive(start, min, max) ||
        !isWholeNumberBetweenInclusive(end, min, max) ||
        start > end) {
        return `Cron range for ${cronPart} must be whole numbers between ${min} and ${max}`;
    }
    return;
};
const validateList = (cronPart, value, min, max) => {
    if (!value
        .split(',')
        .every((v) => isWholeNumberBetweenInclusive(Number(v), min, max))) {
        return `Cron list for ${cronPart} must contain whole numbers between ${min} and ${max}`;
    }
    return;
};
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const translateToCronOptionsWithTimezone = (schedule) => {
    if (isTimeInterval(schedule)) {
        const { value, unit } = parseTimeInterval(schedule.rate);
        switch (unit) {
            case 'm':
                return {
                    minute: `*/${value}`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'h':
                return {
                    minute: '0',
                    hour: `*/${value}`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'day':
                return {
                    minute: '0',
                    hour: '0',
                    day: `*`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'week':
                return {
                    minute: '0',
                    hour: '0',
                    weekDay: `1`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'month':
                return {
                    minute: '0',
                    hour: '0',
                    day: '1',
                    month: `*`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            case 'year':
                return {
                    minute: '0',
                    hour: '0',
                    day: '1',
                    month: '1',
                    year: `*`,
                    timeZone: TimeZone.of(schedule.timezone),
                };
            default:
                // This should never happen with strict types
                throw new Error('Could not determine the schedule rate for the function');
        }
    }
    else {
        const cronArray = schedule.cron.split(' ');
        const result = {
            minute: cronArray[0],
            hour: cronArray[1],
            month: cronArray[3],
            year: cronArray.length === 6 ? cronArray[5] : '*',
            timeZone: TimeZone.of(schedule.timezone),
        };
        // Branching logic here is because we cannot supply both day and weekDay
        if (cronArray[2] === '?') {
            result.weekDay = cronArray[4];
        }
        else {
            result.day = cronArray[2];
        }
        return result;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGVfcGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NjaGVkdWxlX3BhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsa0JBQWtCLEdBQ25CLE1BQU0sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQVN2QyxPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFnQnBCLE1BQU0sZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO0FBRS9CLE1BQU0sZUFBZSxHQUFHLENBQUMsUUFBMEIsRUFBaUIsRUFBRTtJQUNwRSxJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQ2pDLE9BQU8sUUFBUSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7WUFDL0IsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQWtDLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFO1lBQzFFLENBQUMsQ0FBQztnQkFDRSxJQUFJLEVBQUUsUUFBa0M7Z0JBQ3hDLFFBQVEsRUFBRSxnQkFBZ0I7YUFDM0IsQ0FBQztJQUNSLENBQUM7U0FBTSxJQUFJLE1BQU0sSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUM5QixPQUFPLEVBQUUsR0FBRyxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxRQUFRLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztJQUMxRSxDQUFDO1NBQU0sSUFBSSxNQUFNLElBQUksUUFBUSxFQUFFLENBQUM7UUFDOUIsT0FBTyxFQUFFLEdBQUcsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsUUFBUSxJQUFJLGdCQUFnQixFQUFFLENBQUM7SUFDMUUsQ0FBQztJQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztBQUN0RSxDQUFDLENBQUM7QUFFRjs7Ozs7R0FLRztBQUNILE1BQU0sQ0FBQyxNQUFNLDZDQUE2QyxHQUFHLENBQzNE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eUQ7WUFDbkUsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDbEIsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxFQUFFLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUc7WUFDakQsUUFBUSxFQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztTQUN6QyxDQUFDO1FBRUYsd0VBQXdFO1FBQ3hFLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hDLENBQUM7YUFBTSxDQUFDO1lBQ04sTUFBTSxDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUIsQ0FBQztRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7QUFDSCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDcm9uT3B0aW9uc1dpdGhUaW1lem9uZSxcbiAgU2NoZWR1bGVFeHByZXNzaW9uLFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc2NoZWR1bGVyJztcbmltcG9ydCB7IFRpbWVab25lIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgTm9kZWpzRnVuY3Rpb24gfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLW5vZGVqcyc7XG5pbXBvcnQgdHlwZSB7XG4gIENyb25TY2hlZHVsZUV4cHJlc3Npb24sXG4gIEZ1bmN0aW9uU2NoZWR1bGUsXG4gIFRpbWVJbnRlcnZhbEV4cHJlc3Npb24sXG4gIFpvbmVkQ3JvblNjaGVkdWxlLFxuICBab25lZFRpbWVJbnRlcnZhbCxcbn0gZnJvbSAnLi9mYWN0b3J5LmpzJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5cbnR5cGUgQ3JvblBhcnQgPVxuICB8ICdtaW51dGVzJ1xuICB8ICdob3VycydcbiAgfCAnZGF5LW9mLW1vbnRoJ1xuICB8ICdtb250aCdcbiAgfCAnZGF5LW9mLXdlZWsnXG4gIHwgJ3llYXInO1xuXG50eXBlIFpvbmVkU2NoZWR1bGUgPSBab25lZENyb25TY2hlZHVsZSB8IFpvbmVkVGltZUludGVydmFsO1xuXG50eXBlIFdyaXRhYmxlPFQsIEsgZXh0ZW5kcyBrZXlvZiBUPiA9IHtcbiAgLXJlYWRvbmx5IFtQIGluIEtdOiBUW1BdO1xufSAmIE9taXQ8VCwgSz47XG5cbmNvbnN0IERFRkFVTFRfVElNRVpPTkUgPSAnVVRDJztcblxuY29uc3QgaHlkcmF0ZURlZmF1bHRzID0gKHNjaGVkdWxlOiBGdW5jdGlvblNjaGVkdWxlKTogWm9uZWRTY2hlZHVsZSA9PiB7XG4gIGlmICh0eXBlb2Ygc2NoZWR1bGUgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIHNjaGVkdWxlLmluY2x1ZGVzKCdldmVyeScpXG4gICAgICA/IHsgcmF0ZTogc2NoZWR1bGUgYXMgVGltZUludGVydmFsRXhwcmVzc2lvbiwgdGltZXpvbmU6IERFRkFVTFRfVElNRVpPTkUgfVxuICAgICAgOiB7XG4gICAgICAgICAgY3Jvbjogc2NoZWR1bGUgYXMgQ3JvblNjaGVkdWxlRXhwcmVzc2lvbixcbiAgICAgICAgICB0aW1lem9uZTogREVGQVVMVF9USU1FWk9ORSxcbiAgICAgICAgfTtcbiAgfSBlbHNlIGlmICgncmF0ZScgaW4gc2NoZWR1bGUpIHtcbiAgICByZXR1cm4geyAuLi5zY2hlZHVsZSwgdGltZXpvbmU6IHNjaGVkdWxlLnRpbWV6b25lID8/IERFRkFVTFRfVElNRVpPTkUgfTtcbiAgfSBlbHNlIGlmICgnY3JvbicgaW4gc2NoZWR1bGUpIHtcbiAgICByZXR1cm4geyAuLi5zY2hlZHVsZSwgdGltZXpvbmU6IHNjaGVkdWxlLnRpbWV6b25lID8/IERFRkFVTFRfVElNRVpPTkUgfTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgZGV0ZXJtaW5lIHRoZSBmdW5jdGlvbidzIHNjaGVkdWxlIHR5cGVcIik7XG59O1xuXG4vKipcbiAqIENvbnZlcnRzIGZ1bmN0aW9uIHNjaGVkdWxlcyB0byBzY2hlZHVsZSBleHByZXNzaW9ucy5cbiAqIEBwYXJhbSBsYW1iZGEgVGhlIExhbWJkYSBmdW5jdGlvbiB0byBhc3NvY2lhdGUgd2l0aCB0aGUgc2NoZWR1bGVzLlxuICogQHBhcmFtIGZ1bmN0aW9uU2NoZWR1bGVzIFRoZSBmdW5jdGlvbiBzY2hlZHVsZXMgdG8gY29udmVydC5cbiAqIEByZXR1cm5zIEFuIGFycmF5IG9mIHNjaGVkdWxlIGV4cHJlc3Npb25zLlxuICovXG5leHBvcnQgY29uc3QgY29udmVydEZ1bmN0aW9uU2NoZWR1bGVzVG9TY2hlZHVsZUV4cHJlc3Npb25zID0gKFxuICBsYW1iZGE6IE5vZGVqc0Z1bmN0aW9uLFxuICBmdW5jdGlvblNjaGVkdWxlczogRnVuY3Rpb25TY2hlZHVsZSB8IEZ1bmN0aW9uU2NoZWR1bGVbXSxcbik6IFNjaGVkdWxlRXhwcmVzc2lvbltdID0+IHtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCBzY2hlZHVsZUV4cHJlc3Npb25zOiBTY2hlZHVsZUV4cHJlc3Npb25bXSA9IFtdO1xuXG4gIGNvbnN0IHNjaGVkdWxlcyA9IEFycmF5LmlzQXJyYXkoZnVuY3Rpb25TY2hlZHVsZXMpXG4gICAgPyBmdW5jdGlvblNjaGVkdWxlc1xuICAgIDogW2Z1bmN0aW9uU2NoZWR1bGVzXTtcblxuICBjb25zdCB6b25lZFNjaGVkdWxlcyA9IHNjaGVkdWxlcy5tYXAoaHlkcmF0ZURlZmF1bHRzKTtcblxuICB6b25lZFNjaGVkdWxlcy5mb3JFYWNoKChzY2hlZHVsZSkgPT4ge1xuICAgIGlmIChpc1RpbWVJbnRlcnZhbChzY2hlZHVsZSkpIHtcbiAgICAgIGNvbnN0IHsgdmFsdWUsIHVuaXQgfSA9IHBhcnNlVGltZUludGVydmFsKHNjaGVkdWxlLnJhdGUpO1xuXG4gICAgICBpZiAodmFsdWUgJiYgIWlzUG9zaXRpdmVXaG9sZU51bWJlcih2YWx1ZSkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgICAgJ0Z1bmN0aW9uIHNjaGVkdWxlIHJhdGUgbXVzdCBiZSBzZXQgd2l0aCBhIHBvc2l0aXZlIHdob2xlIG51bWJlcicsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICB2YWx1ZSAmJlxuICAgICAgICBsYW1iZGEudGltZW91dCAmJlxuICAgICAgICB1bml0ID09PSAnbScgJiZcbiAgICAgICAgdmFsdWUgKiA2MCA8IGxhbWJkYS50aW1lb3V0LnRvU2Vjb25kcygpXG4gICAgICApIHtcbiAgICAgICAgY29uc3QgdGltZW91dCA9IGxhbWJkYS50aW1lb3V0LnRvU2Vjb25kcygpO1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICBgRnVuY3Rpb24gc2NoZWR1bGUgcmF0ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB0aGUgZnVuY3Rpb24gdGltZW91dCBvZiAke3RpbWVvdXR9ICR7XG4gICAgICAgICAgICB0aW1lb3V0ID4gMSA/ICdzZWNvbmRzJyA6ICdzZWNvbmQnXG4gICAgICAgICAgfWAsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGNyb25FcnJvcnMgPSB2YWxpZGF0ZUNyb24oc2NoZWR1bGUuY3Jvbik7XG5cbiAgICAgIGlmIChjcm9uRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goLi4uY3JvbkVycm9ycyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGVycm9ycy5sZW5ndGggPT09IDApIHtcbiAgICAgIHNjaGVkdWxlRXhwcmVzc2lvbnMucHVzaChcbiAgICAgICAgU2NoZWR1bGVFeHByZXNzaW9uLmNyb24odHJhbnNsYXRlVG9Dcm9uT3B0aW9uc1dpdGhUaW1lem9uZShzY2hlZHVsZSkpLFxuICAgICAgKTtcbiAgICB9XG4gIH0pO1xuXG4gIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgIHRocm93IG5ldyBFcnJvcihlcnJvcnMuam9pbihvcy5FT0wpKTtcbiAgfVxuXG4gIHJldHVybiBzY2hlZHVsZUV4cHJlc3Npb25zO1xufTtcblxuY29uc3QgaXNUaW1lSW50ZXJ2YWwgPSAoXG4gIHNjaGVkdWxlOiBab25lZFNjaGVkdWxlLFxuKTogc2NoZWR1bGUgaXMgWm9uZWRUaW1lSW50ZXJ2YWwgPT4ge1xuICBjb25zdCBleHByZXNzaW9uID0gJ3JhdGUnIGluIHNjaGVkdWxlID8gc2NoZWR1bGUucmF0ZSA6ICcnO1xuICBjb25zdCBwYXJ0cyA9IGV4cHJlc3Npb24uc3BsaXQoJyAnKTtcblxuICByZXR1cm4gKFxuICAgIHBhcnRzWzBdID09PSAnZXZlcnknICYmXG4gICAgWydtJywgJ2gnLCAnZGF5JywgJ3dlZWsnLCAnbW9udGgnLCAneWVhciddLnNvbWUoKGEpID0+XG4gICAgICBwYXJ0c1sxXS5lbmRzV2l0aChhKSxcbiAgICApICYmXG4gICAgcGFydHMubGVuZ3RoID09PSAyXG4gICk7XG59O1xuXG5jb25zdCBwYXJzZVRpbWVJbnRlcnZhbCA9ICh0aW1lSW50ZXJ2YWw6IFRpbWVJbnRlcnZhbEV4cHJlc3Npb24pID0+IHtcbiAgY29uc3QgcGFydCA9IHRpbWVJbnRlcnZhbC5zcGxpdCgnICcpWzFdO1xuICBjb25zdCB2YWx1ZSA9IHBhcnQubWF0Y2goLy0/XFxkK1xcLj9cXGQqLyk7XG4gIGNvbnN0IHVuaXQgPSBwYXJ0Lm1hdGNoKC9bYS16QS1aXSsvKTtcblxuICByZXR1cm4ge1xuICAgIHZhbHVlOiB2YWx1ZSA/IE51bWJlcih2YWx1ZVswXSkgOiB1bmRlZmluZWQsXG4gICAgdW5pdDogdW5pdCA/IHVuaXRbMF0gOiB1bmRlZmluZWQsXG4gIH07XG59O1xuXG5jb25zdCBpc1Bvc2l0aXZlV2hvbGVOdW1iZXIgPSAodGVzdDogbnVtYmVyKSA9PiB0ZXN0ID4gMCAmJiB0ZXN0ICUgMSA9PT0gMDtcblxuY29uc3QgdmFsaWRhdGVDcm9uID0gKGNyb246IENyb25TY2hlZHVsZUV4cHJlc3Npb24pID0+IHtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuICBjb25zdCBjcm9uUGFydHMgPSBjcm9uLnNwbGl0KCcgJyk7XG5cbiAgY29uc3QgW21pbnV0ZSwgaG91ciwgZGF5T2ZNb250aCwgbW9udGgsIGRheU9mV2VlaywgeWVhcl0gPSBjcm9uUGFydHM7XG5cbiAgY29uc3QgbWludXRlVmFsaWRhdGlvbkVycm9ycyA9IHZhbGlkYXRlQ3JvblBhcnQoJ21pbnV0ZXMnLCBtaW51dGUsIDAsIDU5KTtcbiAgY29uc3QgaG91clZhbGlkYXRpb25FcnJvcnMgPSB2YWxpZGF0ZUNyb25QYXJ0KCdob3VycycsIGhvdXIsIDAsIDIzKTtcbiAgY29uc3QgZGF5T2ZNb250aFZhbGlkYXRpb25FcnJvcnMgPVxuICAgIGRheU9mTW9udGggPT09ICc/J1xuICAgICAgPyBbXVxuICAgICAgOiB2YWxpZGF0ZUNyb25QYXJ0KCdkYXktb2YtbW9udGgnLCBkYXlPZk1vbnRoLCAxLCAzMSk7XG4gIGNvbnN0IG1vbnRoVmFsaWRhdGlvbkVycm9ycyA9IHZhbGlkYXRlQ3JvblBhcnQoJ21vbnRoJywgbW9udGgsIDEsIDEyKTtcbiAgY29uc3QgZGF5T2ZXZWVrVmFsaWRhdGlvbkVycm9ycyA9XG4gICAgZGF5T2ZXZWVrID09PSAnPycgPyBbXSA6IHZhbGlkYXRlQ3JvblBhcnQoJ2RheS1vZi13ZWVrJywgZGF5T2ZXZWVrLCAxLCA3KTtcbiAgY29uc3QgeWVhclZhbGlkYXRpb25FcnJvcnMgPSB5ZWFyXG4gICAgPyB2YWxpZGF0ZUNyb25QYXJ0KCd5ZWFyJywgeWVhciwgMTk3MCwgMjE5OSlcbiAgICA6IFtdO1xuXG4gIGVycm9ycy5wdXNoKFxuICAgIC4uLm1pbnV0ZVZhbGlkYXRpb25FcnJvcnMsXG4gICAgLi4uaG91clZhbGlkYXRpb25FcnJvcnMsXG4gICAgLi4uZGF5T2ZNb250aFZhbGlkYXRpb25FcnJvcnMsXG4gICAgLi4ubW9udGhWYWxpZGF0aW9uRXJyb3JzLFxuICAgIC4uLmRheU9mV2Vla1ZhbGlkYXRpb25FcnJvcnMsXG4gICAgLi4ueWVhclZhbGlkYXRpb25FcnJvcnMsXG4gICk7XG5cbiAgaWYgKGRheU9mTW9udGggIT09ICc/JyAmJiBkYXlPZldlZWsgIT09ICc/Jykge1xuICAgIGVycm9ycy5wdXNoKFxuICAgICAgJ0Nyb24gZXhwcmVzc2lvbnMgY2Fubm90IGhhdmUgYm90aCBkYXktb2YtbW9udGggYW5kIGRheS1vZi13ZWVrIGRlZmluZWQsIHlvdSBtdXN0IHVzZSBhID8gaW4gb25lIG9mIHRoZSBmaWVsZHMnLFxuICAgICk7XG4gIH1cblxuICByZXR1cm4gZXJyb3JzO1xufTtcblxuY29uc3QgdmFsaWRhdGVDcm9uUGFydCA9IChcbiAgY3JvblBhcnQ6IENyb25QYXJ0LFxuICB2YWx1ZTogc3RyaW5nLFxuICBtaW46IG51bWJlcixcbiAgbWF4OiBudW1iZXIsXG4pID0+IHtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIGlmICh2YWx1ZSA9PT0gJyonKSB7XG4gICAgcmV0dXJuIGVycm9ycztcbiAgfVxuXG4gIGNvbnN0IGhhc1N0ZXAgPSB2YWx1ZS5pbmNsdWRlcygnLycpO1xuICBjb25zdCBoYXNSYW5nZSA9IHZhbHVlLmluY2x1ZGVzKCctJyk7XG4gIGNvbnN0IGhhc0xpc3QgPSB2YWx1ZS5pbmNsdWRlcygnLCcpO1xuXG4gIGlmIChoYXNMaXN0KSB7XG4gICAgY29uc3QgbGlzdEVycm9yID0gdmFsaWRhdGVMaXN0KGNyb25QYXJ0LCB2YWx1ZSwgbWluLCBtYXgpO1xuXG4gICAgaWYgKGxpc3RFcnJvcikge1xuICAgICAgZXJyb3JzLnB1c2gobGlzdEVycm9yKTtcbiAgICB9XG4gICAgY29uc3QgbGlzdEl0ZW1zID0gdmFsdWUuc3BsaXQoJywnKTtcblxuICAgIGxpc3RJdGVtcy5mb3JFYWNoKChsaXN0SXRlbSkgPT4ge1xuICAgICAgaWYgKGxpc3RJdGVtLmluY2x1ZGVzKCcvJykpIHtcbiAgICAgICAgY29uc3Qgc3RlcEVycm9yID0gdmFsaWRhdGVTdGVwVmFsdWUoY3JvblBhcnQsIGxpc3RJdGVtLCBtaW4sIG1heCk7XG5cbiAgICAgICAgaWYgKHN0ZXBFcnJvcikge1xuICAgICAgICAgIGVycm9ycy5wdXNoKHN0ZXBFcnJvcik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAobGlzdEl0ZW0uaW5jbHVkZXMoJy0nKSkge1xuICAgICAgICBjb25zdCByYW5nZUVycm9yID0gdmFsaWRhdGVSYW5nZShjcm9uUGFydCwgbGlzdEl0ZW0sIG1pbiwgbWF4KTtcblxuICAgICAgICBpZiAocmFuZ2VFcnJvcikge1xuICAgICAgICAgIGVycm9ycy5wdXNoKHJhbmdlRXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH0gZWxzZSBpZiAoaGFzU3RlcCkge1xuICAgIGNvbnN0IHN0ZXBFcnJvciA9IHZhbGlkYXRlU3RlcFZhbHVlKGNyb25QYXJ0LCB2YWx1ZSwgbWluLCBtYXgpO1xuXG4gICAgaWYgKHN0ZXBFcnJvcikge1xuICAgICAgZXJyb3JzLnB1c2goc3RlcEVycm9yKTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoaGFzUmFuZ2UpIHtcbiAgICBjb25zdCByYW5nZUVycm9yID0gdmFsaWRhdGVSYW5nZShjcm9uUGFydCwgdmFsdWUsIG1pbiwgbWF4KTtcblxuICAgIGlmIChyYW5nZUVycm9yKSB7XG4gICAgICBlcnJvcnMucHVzaChyYW5nZUVycm9yKTtcbiAgICB9XG4gIH1cblxuICBpZiAoXG4gICAgIWhhc1N0ZXAgJiZcbiAgICAhaGFzUmFuZ2UgJiZcbiAgICAhaGFzTGlzdCAmJlxuICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShOdW1iZXIodmFsdWUpLCBtaW4sIG1heClcbiAgKSB7XG4gICAgZXJyb3JzLnB1c2goXG4gICAgICBgQ3JvbiBmaWVsZCBmb3IgJHtjcm9uUGFydH0gbXVzdCBiZSBhIHdob2xlIG51bWJlciBiZXR3ZWVuICR7bWlufSBhbmQgJHttYXh9YCxcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIGVycm9ycztcbn07XG5cbmNvbnN0IHZhbGlkYXRlU3RlcFZhbHVlID0gKFxuICBjcm9uUGFydDogQ3JvblBhcnQsXG4gIHZhbHVlOiBzdHJpbmcsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlcixcbikgPT4ge1xuICBjb25zdCBvcmlnaW5hbEJhc2UgPSB2YWx1ZS5zcGxpdCgnLycpWzBdO1xuICBjb25zdCBbYmFzZSwgc3RlcF0gPSB2YWx1ZS5zcGxpdCgnLycpLm1hcChOdW1iZXIpO1xuXG4gIGlmIChvcmlnaW5hbEJhc2UgPT09ICcqJykge1xuICAgIGlmIChpc05hTihzdGVwKSB8fCBzdGVwIDw9IDAgfHwgIWlzUG9zaXRpdmVXaG9sZU51bWJlcihzdGVwKSkge1xuICAgICAgcmV0dXJuIGBDcm9uIHN0ZXAgdmFsdWVzIGZvciAke2Nyb25QYXJ0fSBtdXN0IGJlIHBvc2l0aXZlIHdob2xlIG51bWJlcnNgO1xuICAgIH1cbiAgfSBlbHNlIGlmIChcbiAgICBpc05hTihiYXNlKSB8fFxuICAgIGlzTmFOKHN0ZXApIHx8XG4gICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKGJhc2UsIG1pbiwgbWF4KSB8fFxuICAgIHN0ZXAgPD0gMFxuICApIHtcbiAgICByZXR1cm4gYENyb24gc3RlcCB2YWx1ZXMgZm9yICR7Y3JvblBhcnR9IG11c3QgYmUgd2hvbGUgbnVtYmVycyBiZXR3ZWVuICR7bWlufSBhbmQgJHttYXh9YDtcbiAgfVxuXG4gIHJldHVybjtcbn07XG5cbmNvbnN0IHZhbGlkYXRlUmFuZ2UgPSAoXG4gIGNyb25QYXJ0OiBDcm9uUGFydCxcbiAgdmFsdWU6IHN0cmluZyxcbiAgbWluOiBudW1iZXIsXG4gIG1heDogbnVtYmVyLFxuKSA9PiB7XG4gIGNvbnN0IFtzdGFydCwgZW5kXSA9IHZhbHVlLnNwbGl0KCctJykubWFwKE51bWJlcik7XG5cbiAgaWYgKFxuICAgIGlzTmFOKHN0YXJ0KSB8fFxuICAgIGlzTmFOKGVuZCkgfHxcbiAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoc3RhcnQsIG1pbiwgbWF4KSB8fFxuICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShlbmQsIG1pbiwgbWF4KSB8fFxuICAgIHN0YXJ0ID4gZW5kXG4gICkge1xuICAgIHJldHVybiBgQ3JvbiByYW5nZSBmb3IgJHtjcm9uUGFydH0gbXVzdCBiZSB3aG9sZSBudW1iZXJzIGJldHdlZW4gJHttaW59IGFuZCAke21heH1gO1xuICB9XG5cbiAgcmV0dXJuO1xufTtcblxuY29uc3QgdmFsaWRhdGVMaXN0ID0gKFxuICBjcm9uUGFydDogQ3JvblBhcnQsXG4gIHZhbHVlOiBzdHJpbmcsXG4gIG1pbjogbnVtYmVyLFxuICBtYXg6IG51bWJlcixcbikgPT4ge1xuICBpZiAoXG4gICAgIXZhbHVlXG4gICAgICAuc3BsaXQoJywnKVxuICAgICAgLmV2ZXJ5KCh2KSA9PiBpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZShOdW1iZXIodiksIG1pbiwgbWF4KSlcbiAgKSB7XG4gICAgcmV0dXJuIGBDcm9uIGxpc3QgZm9yICR7Y3JvblBhcnR9IG11c3QgY29udGFpbiB3aG9sZSBudW1iZXJzIGJldHdlZW4gJHttaW59IGFuZCAke21heH1gO1xuICB9XG5cbiAgcmV0dXJuO1xufTtcblxuY29uc3QgaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUgPSAoXG4gIHRlc3Q6IG51bWJlcixcbiAgbWluOiBudW1iZXIsXG4gIG1heDogbnVtYmVyLFxuKSA9PiBtaW4gPD0gdGVzdCAmJiB0ZXN0IDw9IG1heCAmJiB0ZXN0ICUgMSA9PT0gMDtcblxuY29uc3QgdHJhbnNsYXRlVG9Dcm9uT3B0aW9uc1dpdGhUaW1lem9uZSA9IChcbiAgc2NoZWR1bGU6IFpvbmVkU2NoZWR1bGUsXG4pOiBDcm9uT3B0aW9uc1dpdGhUaW1lem9uZSA9PiB7XG4gIGlmIChpc1RpbWVJbnRlcnZhbChzY2hlZHVsZSkpIHtcbiAgICBjb25zdCB7IHZhbHVlLCB1bml0IH0gPSBwYXJzZVRpbWVJbnRlcnZhbChzY2hlZHVsZS5yYXRlKTtcbiAgICBzd2l0Y2ggKHVuaXQpIHtcbiAgICAgIGNhc2UgJ20nOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG1pbnV0ZTogYCovJHt2YWx1ZX1gLFxuICAgICAgICAgIHRpbWVab25lOiBUaW1lWm9uZS5vZihzY2hlZHVsZS50aW1lem9uZSksXG4gICAgICAgIH07XG4gICAgICBjYXNlICdoJzpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtaW51dGU6ICcwJyxcbiAgICAgICAgICBob3VyOiBgKi8ke3ZhbHVlfWAsXG4gICAgICAgICAgdGltZVpvbmU6IFRpbWVab25lLm9mKHNjaGVkdWxlLnRpbWV6b25lKSxcbiAgICAgICAgfTtcbiAgICAgIGNhc2UgJ2RheSc6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbWludXRlOiAnMCcsXG4gICAgICAgICAgaG91cjogJzAnLFxuICAgICAgICAgIGRheTogYCpgLFxuICAgICAgICAgIHRpbWVab25lOiBUaW1lWm9uZS5vZihzY2hlZHVsZS50aW1lem9uZSksXG4gICAgICAgIH07XG4gICAgICBjYXNlICd3ZWVrJzpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBtaW51dGU6ICcwJyxcbiAgICAgICAgICBob3VyOiAnMCcsXG4gICAgICAgICAgd2Vla0RheTogYDFgLFxuICAgICAgICAgIHRpbWVab25lOiBUaW1lWm9uZS5vZihzY2hlZHVsZS50aW1lem9uZSksXG4gICAgICAgIH07XG4gICAgICBjYXNlICdtb250aCc6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbWludXRlOiAnMCcsXG4gICAgICAgICAgaG91cjogJzAnLFxuICAgICAgICAgIGRheTogJzEnLFxuICAgICAgICAgIG1vbnRoOiBgKmAsXG4gICAgICAgICAgdGltZVpvbmU6IFRpbWVab25lLm9mKHNjaGVkdWxlLnRpbWV6b25lKSxcbiAgICAgICAgfTtcbiAgICAgIGNhc2UgJ3llYXInOlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG1pbnV0ZTogJzAnLFxuICAgICAgICAgIGhvdXI6ICcwJyxcbiAgICAgICAgICBkYXk6ICcxJyxcbiAgICAgICAgICBtb250aDogJzEnLFxuICAgICAgICAgIHllYXI6IGAqYCxcbiAgICAgICAgICB0aW1lWm9uZTogVGltZVpvbmUub2Yoc2NoZWR1bGUudGltZXpvbmUpLFxuICAgICAgICB9O1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgLy8gVGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuIHdpdGggc3RyaWN0IHR5cGVzXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnQ291bGQgbm90IGRldGVybWluZSB0aGUgc2NoZWR1bGUgcmF0ZSBmb3IgdGhlIGZ1bmN0aW9uJyxcbiAgICAgICAgKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY3JvbkFycmF5ID0gc2NoZWR1bGUuY3Jvbi5zcGxpdCgnICcpO1xuICAgIGNvbnN0IHJlc3VsdDogV3JpdGFibGU8Q3Jvbk9wdGlvbnNXaXRoVGltZXpvbmUsICdkYXknIHwgJ3dlZWtEYXknPiA9IHtcbiAgICAgIG1pbnV0ZTogY3JvbkFycmF5WzBdLFxuICAgICAgaG91cjogY3JvbkFycmF5WzFdLFxuICAgICAgbW9udGg6IGNyb25BcnJheVszXSxcbiAgICAgIHllYXI6IGNyb25BcnJheS5sZW5ndGggPT09IDYgPyBjcm9uQXJyYXlbNV0gOiAnKicsXG4gICAgICB0aW1lWm9uZTogVGltZVpvbmUub2Yoc2NoZWR1bGUudGltZXpvbmUpLFxuICAgIH07XG5cbiAgICAvLyBCcmFuY2hpbmcgbG9naWMgaGVyZSBpcyBiZWNhdXNlIHdlIGNhbm5vdCBzdXBwbHkgYm90aCBkYXkgYW5kIHdlZWtEYXlcbiAgICBpZiAoY3JvbkFycmF5WzJdID09PSAnPycpIHtcbiAgICAgIHJlc3VsdC53ZWVrRGF5ID0gY3JvbkFycmF5WzRdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQuZGF5ID0gY3JvbkFycmF5WzJdO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn07XG4iXX0=