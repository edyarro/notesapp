"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebsiteNoticeDataSource = exports.WebsiteNoticeDataSourceProps = void 0;
const https = require("node:https");
const toolkit_error_1 = require("../../toolkit/toolkit-error");
const util_1 = require("../../util");
/**
 * A data source that fetches notices from the CDK notices data source
 */
class WebsiteNoticeDataSourceProps {
    /**
     * The URL to load notices from.
     *
     * Note this must be a valid JSON document in the CDK notices data schema.
     *
     * @see https://github.com/cdklabs/aws-cdk-notices
     *
     * @default - Official CDK notices
     */
    url;
    /**
     * The agent responsible for making the network requests.
     *
     * Use this so set up a proxy connection.
     *
     * @default - Uses the shared global node agent
     */
    agent;
}
exports.WebsiteNoticeDataSourceProps = WebsiteNoticeDataSourceProps;
class WebsiteNoticeDataSource {
    ioHelper;
    /**
     * The URL notices are loaded from.
     */
    url;
    agent;
    constructor(ioHelper, props = {}) {
        this.ioHelper = ioHelper;
        this.agent = props.agent;
        this.url = props.url ?? 'https://cli.cdk.dev-tools.aws.dev/notices.json';
    }
    async fetch() {
        // We are observing lots of timeouts when running in a massively parallel
        // integration test environment, so wait for a longer timeout there.
        //
        // In production, have a short timeout to not hold up the user experience.
        const timeout = process.env.TESTING_CDK ? 30_000 : 3_000;
        const options = {
            agent: this.agent,
        };
        const notices = await new Promise((resolve, reject) => {
            let req;
            let timer = setTimeout(() => {
                if (req) {
                    req.destroy(new toolkit_error_1.ToolkitError('Request timed out'));
                }
            }, timeout);
            timer.unref();
            try {
                req = https.get(this.url, options, res => {
                    if (res.statusCode === 200) {
                        res.setEncoding('utf8');
                        let rawData = '';
                        res.on('data', (chunk) => {
                            rawData += chunk;
                        });
                        res.on('end', () => {
                            try {
                                const data = JSON.parse(rawData).notices;
                                if (!data) {
                                    throw new toolkit_error_1.ToolkitError("'notices' key is missing from received data");
                                }
                                resolve(data ?? []);
                            }
                            catch (e) {
                                reject(toolkit_error_1.ToolkitError.withCause(`Parse error: ${(0, util_1.formatErrorMessage)(e)}`, e));
                            }
                        });
                        res.on('error', e => {
                            reject(toolkit_error_1.ToolkitError.withCause((0, util_1.formatErrorMessage)(e), e));
                        });
                    }
                    else {
                        reject(new toolkit_error_1.ToolkitError(`${(0, util_1.humanHttpStatusError)(res.statusCode)} (Status code: ${res.statusCode})`));
                    }
                });
                req.on('error', e => {
                    reject(toolkit_error_1.ToolkitError.withCause((0, util_1.humanNetworkError)(e), e));
                });
            }
            catch (e) {
                reject(toolkit_error_1.ToolkitError.withCause((0, util_1.formatErrorMessage)(e), e));
            }
        });
        await this.ioHelper.defaults.debug('Notices refreshed');
        return notices;
    }
}
exports.WebsiteNoticeDataSource = WebsiteNoticeDataSource;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViLWRhdGEtc291cmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsid2ViLWRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLG9DQUFvQztBQUVwQywrREFBMkQ7QUFDM0QscUNBQXlGO0FBR3pGOztHQUVHO0FBQ0gsTUFBYSw0QkFBNEI7SUFDdkM7Ozs7Ozs7O09BUUc7SUFDTSxHQUFHLENBQWdCO0lBQzVCOzs7Ozs7T0FNRztJQUNNLEtBQUssQ0FBZTtDQUM5QjtBQW5CRCxvRUFtQkM7QUFFRCxNQUFhLHVCQUF1QjtJQVFMO0lBUDdCOztPQUVHO0lBQ2EsR0FBRyxDQUFNO0lBRVIsS0FBSyxDQUFlO0lBRXJDLFlBQTZCLFFBQWtCLEVBQUUsUUFBc0MsRUFBRTtRQUE1RCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQzdDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUN6QixJQUFJLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLElBQUksZ0RBQWdELENBQUM7SUFDM0UsQ0FBQztJQUVELEtBQUssQ0FBQyxLQUFLO1FBQ1QseUVBQXlFO1FBQ3pFLG9FQUFvRTtRQUNwRSxFQUFFO1FBQ0YsMEVBQTBFO1FBQzFFLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUV6RCxNQUFNLE9BQU8sR0FBbUI7WUFDOUIsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1NBQ2xCLENBQUM7UUFFRixNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksT0FBTyxDQUFXLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzlELElBQUksR0FBOEIsQ0FBQztZQUVuQyxJQUFJLEtBQUssR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUMxQixJQUFJLEdBQUcsRUFBRSxDQUFDO29CQUNSLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSw0QkFBWSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztnQkFDckQsQ0FBQztZQUNILENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUVaLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUVkLElBQUksQ0FBQztnQkFDSCxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUN0QixPQUFPLEVBQ1AsR0FBRyxDQUFDLEVBQUU7b0JBQ0osSUFBSSxHQUFHLENBQUMsVUFBVSxLQUFLLEdBQUcsRUFBRSxDQUFDO3dCQUMzQixHQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO3dCQUN4QixJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7d0JBQ2pCLEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7NEJBQ3ZCLE9BQU8sSUFBSSxLQUFLLENBQUM7d0JBQ25CLENBQUMsQ0FBQyxDQUFDO3dCQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRTs0QkFDakIsSUFBSSxDQUFDO2dDQUNILE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBbUIsQ0FBQztnQ0FDckQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO29DQUNWLE1BQU0sSUFBSSw0QkFBWSxDQUFDLDZDQUE2QyxDQUFDLENBQUM7Z0NBQ3hFLENBQUM7Z0NBQ0QsT0FBTyxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQzs0QkFDdEIsQ0FBQzs0QkFBQyxPQUFPLENBQU0sRUFBRSxDQUFDO2dDQUNoQixNQUFNLENBQUMsNEJBQVksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLElBQUEseUJBQWtCLEVBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDOzRCQUM3RSxDQUFDO3dCQUNILENBQUMsQ0FBQyxDQUFDO3dCQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFOzRCQUNsQixNQUFNLENBQUMsNEJBQVksQ0FBQyxTQUFTLENBQUMsSUFBQSx5QkFBa0IsRUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUMzRCxDQUFDLENBQUMsQ0FBQztvQkFDTCxDQUFDO3lCQUFNLENBQUM7d0JBQ04sTUFBTSxDQUFDLElBQUksNEJBQVksQ0FBQyxHQUFHLElBQUEsMkJBQW9CLEVBQUMsR0FBRyxDQUFDLFVBQVcsQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDeEcsQ0FBQztnQkFDSCxDQUFDLENBQUMsQ0FBQztnQkFDTCxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRTtvQkFDbEIsTUFBTSxDQUFDLDRCQUFZLENBQUMsU0FBUyxDQUFDLElBQUEsd0JBQWlCLEVBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDMUQsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDO1lBQUMsT0FBTyxDQUFNLEVBQUUsQ0FBQztnQkFDaEIsTUFBTSxDQUFDLDRCQUFZLENBQUMsU0FBUyxDQUFDLElBQUEseUJBQWtCLEVBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzRCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ3hELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7Q0FDRjtBQTFFRCwwREEwRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IENsaWVudFJlcXVlc3QgfSBmcm9tICdub2RlOmh0dHAnO1xuaW1wb3J0IHR5cGUgeyBSZXF1ZXN0T3B0aW9ucyB9IGZyb20gJ25vZGU6aHR0cHMnO1xuaW1wb3J0ICogYXMgaHR0cHMgZnJvbSAnbm9kZTpodHRwcyc7XG5pbXBvcnQgdHlwZSB7IE5vdGljZSwgTm90aWNlRGF0YVNvdXJjZSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgVG9vbGtpdEVycm9yIH0gZnJvbSAnLi4vLi4vdG9vbGtpdC90b29sa2l0LWVycm9yJztcbmltcG9ydCB7IGZvcm1hdEVycm9yTWVzc2FnZSwgaHVtYW5IdHRwU3RhdHVzRXJyb3IsIGh1bWFuTmV0d29ya0Vycm9yIH0gZnJvbSAnLi4vLi4vdXRpbCc7XG5pbXBvcnQgdHlwZSB7IElvSGVscGVyIH0gZnJvbSAnLi4vaW8vcHJpdmF0ZSc7XG5cbi8qKlxuICogQSBkYXRhIHNvdXJjZSB0aGF0IGZldGNoZXMgbm90aWNlcyBmcm9tIHRoZSBDREsgbm90aWNlcyBkYXRhIHNvdXJjZVxuICovXG5leHBvcnQgY2xhc3MgV2Vic2l0ZU5vdGljZURhdGFTb3VyY2VQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgVVJMIHRvIGxvYWQgbm90aWNlcyBmcm9tLlxuICAgKlxuICAgKiBOb3RlIHRoaXMgbXVzdCBiZSBhIHZhbGlkIEpTT04gZG9jdW1lbnQgaW4gdGhlIENESyBub3RpY2VzIGRhdGEgc2NoZW1hLlxuICAgKlxuICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9jZGtsYWJzL2F3cy1jZGstbm90aWNlc1xuICAgKlxuICAgKiBAZGVmYXVsdCAtIE9mZmljaWFsIENESyBub3RpY2VzXG4gICAqL1xuICByZWFkb25seSB1cmw/OiBzdHJpbmcgfCBVUkw7XG4gIC8qKlxuICAgKiBUaGUgYWdlbnQgcmVzcG9uc2libGUgZm9yIG1ha2luZyB0aGUgbmV0d29yayByZXF1ZXN0cy5cbiAgICpcbiAgICogVXNlIHRoaXMgc28gc2V0IHVwIGEgcHJveHkgY29ubmVjdGlvbi5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBVc2VzIHRoZSBzaGFyZWQgZ2xvYmFsIG5vZGUgYWdlbnRcbiAgICovXG4gIHJlYWRvbmx5IGFnZW50PzogaHR0cHMuQWdlbnQ7XG59XG5cbmV4cG9ydCBjbGFzcyBXZWJzaXRlTm90aWNlRGF0YVNvdXJjZSBpbXBsZW1lbnRzIE5vdGljZURhdGFTb3VyY2Uge1xuICAvKipcbiAgICogVGhlIFVSTCBub3RpY2VzIGFyZSBsb2FkZWQgZnJvbS5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSB1cmw6IGFueTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGFnZW50PzogaHR0cHMuQWdlbnQ7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBpb0hlbHBlcjogSW9IZWxwZXIsIHByb3BzOiBXZWJzaXRlTm90aWNlRGF0YVNvdXJjZVByb3BzID0ge30pIHtcbiAgICB0aGlzLmFnZW50ID0gcHJvcHMuYWdlbnQ7XG4gICAgdGhpcy51cmwgPSBwcm9wcy51cmwgPz8gJ2h0dHBzOi8vY2xpLmNkay5kZXYtdG9vbHMuYXdzLmRldi9ub3RpY2VzLmpzb24nO1xuICB9XG5cbiAgYXN5bmMgZmV0Y2goKTogUHJvbWlzZTxOb3RpY2VbXT4ge1xuICAgIC8vIFdlIGFyZSBvYnNlcnZpbmcgbG90cyBvZiB0aW1lb3V0cyB3aGVuIHJ1bm5pbmcgaW4gYSBtYXNzaXZlbHkgcGFyYWxsZWxcbiAgICAvLyBpbnRlZ3JhdGlvbiB0ZXN0IGVudmlyb25tZW50LCBzbyB3YWl0IGZvciBhIGxvbmdlciB0aW1lb3V0IHRoZXJlLlxuICAgIC8vXG4gICAgLy8gSW4gcHJvZHVjdGlvbiwgaGF2ZSBhIHNob3J0IHRpbWVvdXQgdG8gbm90IGhvbGQgdXAgdGhlIHVzZXIgZXhwZXJpZW5jZS5cbiAgICBjb25zdCB0aW1lb3V0ID0gcHJvY2Vzcy5lbnYuVEVTVElOR19DREsgPyAzMF8wMDAgOiAzXzAwMDtcblxuICAgIGNvbnN0IG9wdGlvbnM6IFJlcXVlc3RPcHRpb25zID0ge1xuICAgICAgYWdlbnQ6IHRoaXMuYWdlbnQsXG4gICAgfTtcblxuICAgIGNvbnN0IG5vdGljZXMgPSBhd2FpdCBuZXcgUHJvbWlzZTxOb3RpY2VbXT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGV0IHJlcTogQ2xpZW50UmVxdWVzdCB8IHVuZGVmaW5lZDtcblxuICAgICAgbGV0IHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGlmIChyZXEpIHtcbiAgICAgICAgICByZXEuZGVzdHJveShuZXcgVG9vbGtpdEVycm9yKCdSZXF1ZXN0IHRpbWVkIG91dCcpKTtcbiAgICAgICAgfVxuICAgICAgfSwgdGltZW91dCk7XG5cbiAgICAgIHRpbWVyLnVucmVmKCk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIHJlcSA9IGh0dHBzLmdldCh0aGlzLnVybCxcbiAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgIHJlcyA9PiB7XG4gICAgICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICAgICAgICByZXMuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICAgICAgICAgICAgbGV0IHJhd0RhdGEgPSAnJztcbiAgICAgICAgICAgICAgcmVzLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7XG4gICAgICAgICAgICAgICAgcmF3RGF0YSArPSBjaHVuaztcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIHJlcy5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShyYXdEYXRhKS5ub3RpY2VzIGFzIE5vdGljZVtdO1xuICAgICAgICAgICAgICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUb29sa2l0RXJyb3IoXCInbm90aWNlcycga2V5IGlzIG1pc3NpbmcgZnJvbSByZWNlaXZlZCBkYXRhXCIpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhID8/IFtdKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgIHJlamVjdChUb29sa2l0RXJyb3Iud2l0aENhdXNlKGBQYXJzZSBlcnJvcjogJHtmb3JtYXRFcnJvck1lc3NhZ2UoZSl9YCwgZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIHJlcy5vbignZXJyb3InLCBlID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoVG9vbGtpdEVycm9yLndpdGhDYXVzZShmb3JtYXRFcnJvck1lc3NhZ2UoZSksIGUpKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICByZWplY3QobmV3IFRvb2xraXRFcnJvcihgJHtodW1hbkh0dHBTdGF0dXNFcnJvcihyZXMuc3RhdHVzQ29kZSEpfSAoU3RhdHVzIGNvZGU6ICR7cmVzLnN0YXR1c0NvZGV9KWApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgcmVxLm9uKCdlcnJvcicsIGUgPT4ge1xuICAgICAgICAgIHJlamVjdChUb29sa2l0RXJyb3Iud2l0aENhdXNlKGh1bWFuTmV0d29ya0Vycm9yKGUpLCBlKSk7XG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgICAgIHJlamVjdChUb29sa2l0RXJyb3Iud2l0aENhdXNlKGZvcm1hdEVycm9yTWVzc2FnZShlKSwgZSkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgYXdhaXQgdGhpcy5pb0hlbHBlci5kZWZhdWx0cy5kZWJ1ZygnTm90aWNlcyByZWZyZXNoZWQnKTtcbiAgICByZXR1cm4gbm90aWNlcztcbiAgfVxufVxuIl19